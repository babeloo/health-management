# EMQX ACL (Access Control List) 配置
#
# 此配置文件定义了设备的主题访问权限
#
# ACL 规则说明:
# - 每个规则包含: permission, principal, action, topics
# - permission: allow | deny
# - principal: all | {username: "xxx"} | {clientid: "xxx"}
# - action: publish | subscribe | all
# - topics: 主题列表 (支持通配符)
#
# 工作流程:
# 1. 设备认证成功后,EMQX 检查 ACL 规则
# 2. 按规则顺序匹配,第一个匹配的规则生效
# 3. 如果没有规则匹配,默认拒绝访问

authorization {
  no_match = deny
  deny_action = disconnect

  sources = [
    {
      type = postgresql
      enable = true

      server = "${POSTGRES_HOST:postgres}:${POSTGRES_PORT:5432}"
      database = "${POSTGRES_DB:health_mgmt}"
      username = "${POSTGRES_USER:health_mgmt_user}"
      password = "${POSTGRES_PASSWORD:health_mgmt_password}"

      # ACL 查询: 从数据库获取设备的访问权限
      # 查询结果应包含以下字段:
      # - permission: 'allow' 或 'deny'
      # - action: 'publish', 'subscribe', 或 'all'
      # - topic: 主题 (可使用 %c 代表 clientid, %u 代表 username)
      #
      # 示例:
      # deviceId = 'AA:BB:CC:DD:EE:FF'
      # mqtt_username = 'device_AA_BB_CC_DD_EE_FF'
      # mqtt_client_id = 'mqtt_client_AA_BB_CC_DD_EE_FF'
      #
      # 允许设备发布到: devices/AA:BB:CC:DD:EE:FF/data
      # 允许设备订阅: devices/AA:BB:CC:DD:EE:FF/command

      query = "SELECT 'allow' as permission, action, topic FROM ( \
        SELECT 'publish' as action, 'devices/' || device_id || '/data' as topic FROM devices WHERE mqtt_username = ${username} \
        UNION ALL \
        SELECT 'subscribe' as action, 'devices/' || device_id || '/command' as topic FROM devices WHERE mqtt_username = ${username} \
      ) acl_rules"

      pool_size = 8
      query_timeout = 5s
    },
    {
      # 静态 ACL 规则 (作为后备)
      type = file
      enable = true

      rules = [
        # 允许所有客户端订阅自己的命令主题
        # 主题模式: devices/+/command
        {
          permission = allow
          action = subscribe
          topics = ["devices/+/command"]
        },

        # 拒绝所有客户端访问其他设备的数据
        {
          permission = deny
          action = all
          topics = ["devices/#"]
        },

        # 允许管理员访问所有主题
        {
          permission = allow
          principal = {username = "admin"}
          action = all
          topics = ["#"]
        }
      ]
    }
  ]
}
