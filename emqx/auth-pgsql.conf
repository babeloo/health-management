# EMQX PostgreSQL 认证配置
#
# 此配置文件定义了 EMQX 如何使用 PostgreSQL 数据库进行设备认证
#
# 工作流程:
# 1. 设备使用 MQTT username 和 password 连接
# 2. EMQX 查询 devices 表验证凭证
# 3. 使用 bcrypt 验证密码哈希
#
# 数据库表结构: devices (在 Prisma schema 中定义)
# - mqtt_username: MQTT 用户名
# - mqtt_password_hash: bcrypt 加密的密码
# - status: 设备状态 (ACTIVE 才允许连接)

authentication {
  enable = true
  mechanism = password_based
  backend = postgresql

  server = "${POSTGRES_HOST:postgres}:${POSTGRES_PORT:5432}"
  database = "${POSTGRES_DB:health_mgmt}"
  username = "${POSTGRES_USER:health_mgmt_user}"
  password = "${POSTGRES_PASSWORD:health_mgmt_password}"

  # 认证查询: 根据 MQTT username 查找设备记录
  # 返回字段:
  # - password_hash: bcrypt 加密的密码,用于验证
  # - salt: 如果使用 bcrypt,此字段可选
  password_hash_algorithm {
    name = bcrypt
  }

  query = "SELECT mqtt_password_hash as password_hash FROM devices WHERE mqtt_username = ${username} AND status = 'ACTIVE' LIMIT 1"

  # 连接池配置
  pool_size = 8

  # 查询超时 (毫秒)
  query_timeout = 5s
}
