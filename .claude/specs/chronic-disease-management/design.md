# æ™ºæ…§æ…¢ç—…ç®¡ç†ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## 1. æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

æœ¬ç³»ç»Ÿæ—¨åœ¨æ„å»ºä¸€ä¸ªæ·±åº¦èåˆAIå¤§æ¨¡å‹ï¼ˆDeepSeekç­‰ï¼‰çš„æ™ºæ…§æ…¢ç—…ç®¡ç†å¹³å°ï¼Œå®ç°"é™¢å†…+é™¢å¤–"ã€"çº¿ä¸Š+çº¿ä¸‹"ä¸€ä½“åŒ–æœåŠ¡ã€‚ç³»ç»Ÿæ”¯æŒæ‚£è€…ã€åŒ»ç”Ÿã€å¥åº·ç®¡ç†å¸ˆä¸‰ç«¯åº”ç”¨å’Œç®¡ç†åå°ï¼Œæä¾›å¥åº·æ¡£æ¡ˆç®¡ç†ã€æ™ºèƒ½æ‰“å¡ã€é£é™©è¯„ä¼°ã€AIå¥åº·åŠ©æ‰‹ã€å¤šæ–¹åä½œç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### 1.2 è®¾è®¡åŸåˆ™

- **æ¨¡å—åŒ–è®¾è®¡**ï¼šå„åŠŸèƒ½æ¨¡å—é«˜å†…èšä½è€¦åˆï¼Œä¾¿äºç‹¬ç«‹å¼€å‘å’Œç»´æŠ¤
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¤šAIæ¨¡å‹æä¾›å•†æ¥å…¥ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- **é«˜å¯ç”¨æ€§**ï¼šå…³é”®æœåŠ¡é‡‡ç”¨å†—ä½™è®¾è®¡ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œ
- **å®‰å…¨æ€§ä¼˜å…ˆ**ï¼šåŒ»ç–—æ•°æ®åŠ å¯†å­˜å‚¨ï¼Œä¸¥æ ¼çš„è®¿é—®æ§åˆ¶å’Œå®¡è®¡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜ç­–ç•¥ã€å¼‚æ­¥å¤„ç†ã€æ•°æ®åº“ä¼˜åŒ–ç¡®ä¿å“åº”é€Ÿåº¦
- **è·¨å¹³å°æ”¯æŒ**ï¼šWebç«¯ã€iOSã€Androidç»Ÿä¸€æ¶æ„ï¼Œä»£ç å¤ç”¨

### 1.3 æŠ€æœ¯æ¶æ„æ¼”è¿›ç­–ç•¥

æœ¬ç³»ç»Ÿé‡‡ç”¨**æ¸è¿›å¼æ¼”è¿›æ¶æ„**ï¼Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

#### é˜¶æ®µä¸€ï¼šMVPå¿«é€Ÿä¸Šçº¿æ–¹æ¡ˆï¼ˆ3-4ä¸ªæœˆï¼‰
ç›®æ ‡ï¼šå¿«é€ŸéªŒè¯å¸‚åœºéœ€æ±‚ï¼Œä½æˆæœ¬è·å–æ—©æœŸç”¨æˆ·åé¦ˆ

#### é˜¶æ®µäºŒï¼šä¼ä¸šçº§å‡çº§æ–¹æ¡ˆï¼ˆ6-8ä¸ªæœˆï¼‰
ç›®æ ‡ï¼šæœåŠ¡å¤§å‹åŒ»ç–—æœºæ„ï¼Œæ”¯æŒé«˜å¹¶å‘ã€é«˜å¯ç”¨

---

### 1.3.1 MVPé˜¶æ®µæŠ€æœ¯æ ˆï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰

**å‰ç«¯æŠ€æœ¯æ ˆ**ï¼š
- **æ‚£è€…ç«¯**ï¼šUni-appï¼ˆVue 3è¯­æ³•ï¼‰
  - ç¼–è¯‘ç›®æ ‡ï¼šå¾®ä¿¡å°ç¨‹åºï¼ˆä¸»è¦ï¼‰+ H5 + iOS/Android App
  - UIæ¡†æ¶ï¼šuni-ui / uView
  - çŠ¶æ€ç®¡ç†ï¼šPinia
- **åŒ»ç”Ÿç«¯/ç®¡ç†ç«¯**ï¼šReact 18 + TypeScript + Vite
  - UIæ¡†æ¶ï¼šAnt Design Pro
  - çŠ¶æ€ç®¡ç†ï¼šZustand
  - å›¾è¡¨ï¼šECharts

**åç«¯æŠ€æœ¯æ ˆ**ï¼š
- **ä¸»æ¡†æ¶**ï¼šNode.js 18 + NestJSï¼ˆTypeScriptï¼‰
  - å•ä½“æ¶æ„ï¼ˆæ¨¡å—åŒ–è®¾è®¡ï¼Œé¢„ç•™å¾®æœåŠ¡æ‹†åˆ†æ¥å£ï¼‰
- **APIæ ‡å‡†**ï¼šRESTful API
- **æ•°æ®åº“**ï¼š
  - PostgreSQL 15ï¼ˆä¸»æ•°æ®åº“ï¼‰
  - InfluxDB 2.7ï¼ˆæ—¶åºæ•°æ®ï¼šè¡€å‹ã€è¡€ç³–ç­‰å¥åº·æŒ‡æ ‡ï¼‰
  - Redis 7ï¼ˆç¼“å­˜ã€Sessionã€æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
  - Qdrantï¼ˆå‘é‡æ•°æ®åº“ï¼ŒRAGçŸ¥è¯†åº“ï¼‰
- **ORM**ï¼šPrisma
- **è®¤è¯æˆæƒ**ï¼šJWT + Passport.js + RBAC
- **å®æ—¶é€šä¿¡**ï¼šSocket.io
- **ä»»åŠ¡é˜Ÿåˆ—**ï¼šBullï¼ˆåŸºäºRedisï¼‰
- **æ–‡ä»¶å­˜å‚¨**ï¼šMinIOï¼ˆç§æœ‰åŒ–ï¼‰/ é˜¿é‡Œäº‘OSS

**AIæœåŠ¡**ï¼ˆç‹¬ç«‹å¾®æœåŠ¡ï¼‰ï¼š
- **æ¡†æ¶**ï¼šPython 3.11 + FastAPI
- **å¤§æ¨¡å‹**ï¼šDeepSeek API
- **AIæ¡†æ¶**ï¼šLangChain + LlamaIndex
- **å‘é‡æ£€ç´¢**ï¼šQdrant
- **éƒ¨ç½²**ï¼šç‹¬ç«‹å®¹å™¨ï¼Œé€šè¿‡HTTPä¸ä¸»åç«¯é€šä¿¡

**ç‰©è”ç½‘è®¾å¤‡æ¥å…¥**ï¼š
- **åè®®**ï¼šMQTT
- **Broker**ï¼šEMQXï¼ˆå¼€æºç‰ˆï¼‰

**éƒ¨ç½²æ–¹æ¡ˆ**ï¼š
- **å®¹å™¨åŒ–**ï¼šDocker + Docker Compose
- **æœåŠ¡å™¨**ï¼šå•å°é˜¿é‡Œäº‘ECSï¼ˆ4æ ¸8Gèµ·æ­¥ï¼‰
- **CI/CD**ï¼šGitHub Actions
- **ç›‘æ§**ï¼šç®€åŒ–ç‰ˆï¼ˆDockeræ—¥å¿— + åº”ç”¨æ—¥å¿—ï¼‰

---

### 1.3.2 ä¼ä¸šçº§é˜¶æ®µæŠ€æœ¯æ ˆï¼ˆç¬¬äºŒé˜¶æ®µï¼‰

**å‰ç«¯æŠ€æœ¯æ ˆ**ï¼ˆå¤ç”¨MVPä»£ç ï¼‰ï¼š
- **æ‚£è€…ç«¯**ï¼šUni-appï¼ˆä¸å˜ï¼‰
- **åŒ»ç”Ÿç«¯/ç®¡ç†ç«¯**ï¼šReactï¼ˆå¢å¼ºï¼‰
  - å¢åŠ ç¦»çº¿ç¼“å­˜ã€æ€§èƒ½ä¼˜åŒ–
  - å¼•å…¥å¾®å‰ç«¯æ¶æ„ï¼ˆqiankunï¼‰æ”¯æŒå¤šæœºæ„å®šåˆ¶

**åç«¯æŠ€æœ¯æ ˆ**ï¼ˆæ¶æ„å‡çº§ï¼‰ï¼š
- **æ ¸å¿ƒé€‰å‹**ï¼šJava 17 + Spring Cloud Alibaba
  - å¾®æœåŠ¡æ¶æ„ï¼ˆä»NestJSå¹³æ»‘è¿ç§»ï¼‰
- **æœåŠ¡æ³¨å†Œ/é…ç½®**ï¼šNacos
- **APIç½‘å…³**ï¼šSpring Cloud Gateway + Sentinelï¼ˆé™æµç†”æ–­ï¼‰
- **æ¶ˆæ¯ä¸­é—´ä»¶**ï¼šRocketMQ
- **æ•°æ®åº“**ï¼š
  - MySQL 8.0ï¼ˆä¸»åº“ï¼Œè¯»å†™åˆ†ç¦»ï¼‰
  - InfluxDBï¼ˆä¿æŒï¼‰
  - Redis Clusterï¼ˆé›†ç¾¤ç‰ˆï¼‰
  - Milvusï¼ˆå‘é‡åº“å‡çº§ï¼‰
- **åˆ†åº“åˆ†è¡¨**ï¼šShardingSphere
- **è®¤è¯æˆæƒ**ï¼šSpring Security + OAuth2 + RBAC
- **æ–‡ä»¶å­˜å‚¨**ï¼šå¯¹è±¡å­˜å‚¨ï¼ˆé˜¿é‡Œäº‘OSS / ç§æœ‰MinIOé›†ç¾¤ï¼‰

**AIæœåŠ¡**ï¼ˆä¿æŒä¸å˜ï¼‰ï¼š
- Python FastAPIï¼ˆæ ¸å¿ƒä»£ç å¤ç”¨ï¼‰
- å¢åŠ æ¨¡å‹å¾®è°ƒèƒ½åŠ›
- æ”¯æŒç§æœ‰åŒ–éƒ¨ç½²DeepSeekæ¨¡å‹

**ç‰©è”ç½‘è®¾å¤‡**ï¼ˆä¿æŒï¼‰ï¼š
- MQTT + EMQXï¼ˆå‡çº§ä¸ºä¼ä¸šç‰ˆï¼‰

**éƒ¨ç½²æ–¹æ¡ˆ**ï¼š
- **ç¼–æ’**ï¼šKubernetesï¼ˆK8sï¼‰
- **æœåŠ¡å™¨**ï¼šå¤šå°æœåŠ¡å™¨é›†ç¾¤ï¼ˆé«˜å¯ç”¨ï¼‰
- **ç›‘æ§**ï¼šPrometheus + Grafana
- **æ—¥å¿—**ï¼šELK Stackï¼ˆElasticsearch + Logstash + Kibanaï¼‰
- **é“¾è·¯è¿½è¸ª**ï¼šSkyWalking
- **å®‰å…¨**ï¼šç­‰ä¿ä¸‰çº§åˆè§„æ”¹é€ 

---

### 1.3.3 æ¶æ„æ¼”è¿›è·¯å¾„å¯¹æ¯”

| ç»´åº¦ | MVPé˜¶æ®µ | ä¼ä¸šçº§é˜¶æ®µ | è¿ç§»ç­–ç•¥ |
|------|---------|------------|----------|
| **å‰ç«¯** | Uni-app + React | åŒå·¦ï¼ˆå¤ç”¨ä»£ç ï¼‰ | âœ… æ— éœ€è¿ç§» |
| **åç«¯è¯­è¨€** | Node.js/TypeScript | Java/Spring Cloud | ğŸ”„ é‡å†™ï¼ˆæ¥å£å®šä¹‰å¤ç”¨ï¼‰ |
| **AIæœåŠ¡** | Python FastAPI | åŒå·¦ï¼ˆå¢å¼ºï¼‰ | âœ… ä»£ç å¤ç”¨ |
| **æ•°æ®åº“** | PostgreSQL | MySQL | ğŸ”„ æ•°æ®è¿ç§» |
| **æ—¶åºåº“** | InfluxDB | åŒå·¦ | âœ… æ— éœ€è¿ç§» |
| **å‘é‡åº“** | Qdrant | Milvus | ğŸ”„ æ•°æ®è¿ç§» |
| **ç¼“å­˜** | Rediså•æœº | Redis Cluster | ğŸ”„ é…ç½®å‡çº§ |
| **éƒ¨ç½²** | Docker Compose | Kubernetes | ğŸ”„ é‡æ–°ç¼–æ’ |
| **ç‰©è”ç½‘** | MQTT/EMQX | åŒå·¦ï¼ˆä¼ä¸šç‰ˆï¼‰ | âœ… é…ç½®å‡çº§ |

**å…³é”®è¿ç§»ç‚¹**ï¼š
- âœ… ç»¿è‰²ï¼šå¯ç›´æ¥å¤ç”¨ï¼Œæ— éœ€ä¿®æ”¹
- ğŸ”„ é»„è‰²ï¼šéœ€è¦è¿ç§»ï¼Œä½†æœ‰å·¥å…·æ”¯æŒ
- âš ï¸ çº¢è‰²ï¼šéœ€è¦é‡å†™ï¼ˆæ— ï¼‰

---

### 1.3.4 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

#### MVPé˜¶æ®µé€‰æ‹©Node.jsçš„ç†ç”±ï¼š
1. **å¼€å‘é€Ÿåº¦å¿«**ï¼šå‰åç«¯ç»Ÿä¸€è¯­è¨€ï¼Œå›¢é˜Ÿåä½œæˆæœ¬ä½
2. **ç”Ÿæ€ä¸°å¯Œ**ï¼šnpmåŒ…ä¸°å¯Œï¼Œå¿«é€Ÿé›†æˆç¬¬ä¸‰æ–¹æœåŠ¡
3. **æˆæœ¬ä½**ï¼šå•å°æœåŠ¡å™¨å³å¯è¿è¡Œï¼ŒèŠ‚çœåˆæœŸæˆæœ¬
4. **TypeScript**ï¼šç±»å‹å®‰å…¨ï¼Œä»£ç è´¨é‡æœ‰ä¿éšœ
5. **æ¨¡å—åŒ–è®¾è®¡**ï¼šNestJSå¤©ç„¶æ”¯æŒæ¨¡å—åŒ–ï¼Œä¸ºå¾®æœåŠ¡æ‹†åˆ†åšå‡†å¤‡

#### ä¼ä¸šçº§é˜¶æ®µåˆ‡æ¢Javaçš„ç†ç”±ï¼š
1. **åŒ»ç–—è¡Œä¸šæ ‡å‡†**ï¼šå¤§å‹åŒ»é™¢HISç³»ç»Ÿå¤šä¸ºJavaï¼Œå¯¹æ¥å®¹æ˜“
2. **ç¨³å®šæ€§éªŒè¯**ï¼šç»è¿‡å¤§é‡é‡‘èã€åŒ»ç–—é¡¹ç›®éªŒè¯
3. **ç­‰ä¿åˆè§„**ï¼šç¬¦åˆç­‰ä¿ä¸‰çº§è¦æ±‚ï¼Œå®‰å…¨æ–¹æ¡ˆæˆç†Ÿ
4. **å›¢é˜Ÿæ‰©å¼ **ï¼šJavaå·¥ç¨‹å¸ˆå¸‚åœºæˆç†Ÿï¼Œæ˜“äºæ‹›è˜
5. **ç”Ÿæ€æˆç†Ÿ**ï¼šSpring Cloudå…¨å®¶æ¡¶ï¼Œå¾®æœåŠ¡æ²»ç†å®Œå–„

#### AIæœåŠ¡å§‹ç»ˆä½¿ç”¨Pythonçš„ç†ç”±ï¼š
1. **AIç”Ÿæ€æ— å¯æ›¿ä»£**ï¼šLangChainã€Transformersç­‰æ¡†æ¶åªæœ‰Pythonç‰ˆæœ¬æˆç†Ÿ
2. **DeepSeeké›†æˆ**ï¼šå®˜æ–¹SDKã€æ¨¡å‹å¾®è°ƒå·¥å…·éƒ½æ˜¯Pythonä¼˜å…ˆ
3. **ç‹¬ç«‹æ¼”è¿›**ï¼šAIç®—æ³•è¿­ä»£å¿«ï¼ŒPythonçµæ´»æ€§æ›´é€‚åˆå¿«é€Ÿå®éªŒ
4. **ä»£ç å¤ç”¨**ï¼šä»MVPåˆ°ä¼ä¸šç‰ˆï¼ŒAIæ ¸å¿ƒä»£ç å¯100%å¤ç”¨

---

### 1.3.5 å¹³æ»‘è¿ç§»ä¿éšœ

ä¸ºç¡®ä¿ä»MVPåˆ°ä¼ä¸šçº§çš„å¹³æ»‘è¿‡æ¸¡ï¼Œè®¾è®¡æ—¶éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

#### 1. æ¥å£æ ‡å‡†åŒ–
```typescript
// MVPé˜¶æ®µï¼ˆNode.jsï¼‰å®šä¹‰çš„æ¥å£
interface HealthCheckInRequest {
  userId: string;
  type: 'blood_pressure' | 'blood_sugar';
  data: {
    systolic?: number;
    diastolic?: number;
    bloodSugar?: number;
  };
  timestamp: Date;
}

// ä¼ä¸šçº§é˜¶æ®µï¼ˆJavaï¼‰ä¿æŒç›¸åŒæ¥å£å®šä¹‰
// å‰ç«¯ä»£ç æ— éœ€ä¿®æ”¹
```

#### 2. æ•°æ®åº“è®¾è®¡å‰ç»æ€§
```sql
-- MVPé˜¶æ®µå»ºè¡¨æ—¶å°±è€ƒè™‘åˆ†åº“åˆ†è¡¨
CREATE TABLE check_ins (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  -- é¢„ç•™åˆ†ç‰‡é”®
  shard_key VARCHAR(50) GENERATED ALWAYS AS (SUBSTRING(user_id::text, 1, 2)) STORED,
  type VARCHAR(50) NOT NULL,
  data JSONB NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- ä¸ºæœªæ¥åˆ†è¡¨åšå‡†å¤‡çš„ç´¢å¼•
  INDEX idx_shard_user (shard_key, user_id, created_at)
);
```

#### 3. AIæœåŠ¡ç‹¬ç«‹éƒ¨ç½²
```yaml
# AIæœåŠ¡é€šè¿‡ç‹¬ç«‹åŸŸåè®¿é—®
MVPé˜¶æ®µ:  http://ai-service:8000
ä¼ä¸šç‰ˆ:    http://ai-service:8000  # ç›¸åŒæ¥å£ï¼Œæ— éœ€æ”¹åŠ¨

# å‰ç«¯/åç«¯è°ƒç”¨æ–¹å¼ä¸å˜
POST /ai/chat
POST /ai/health-advice
```

#### 4. é…ç½®å¤–éƒ¨åŒ–
```yaml
# config/database.yml
# MVPå’Œä¼ä¸šç‰ˆä½¿ç”¨ç›¸åŒé…ç½®ç»“æ„ï¼Œåªæ”¹è¿æ¥ä¸²
production:
  primary:
    url: ${DATABASE_URL}  # MVP: PostgreSQL / ä¼ä¸šç‰ˆ: MySQL
  timeseries:
    url: ${INFLUXDB_URL}  # ä¸¤é˜¶æ®µä¸å˜
```

---

### 1.3.6 æ•°æ®å®‰å…¨ï¼ˆä¸¤é˜¶æ®µé€šç”¨ï¼‰

æ— è®ºMVPè¿˜æ˜¯ä¼ä¸šçº§ï¼Œéƒ½å¿…é¡»æ»¡è¶³ï¼š
- **åŠ å¯†**ï¼šAES-256ï¼ˆæ•°æ®åŠ å¯†ï¼‰+ TLS 1.3ï¼ˆä¼ è¾“åŠ å¯†ï¼‰
- **æ•æ„Ÿæ•°æ®**ï¼šèº«ä»½è¯ã€ç—…å†ç­‰å­—æ®µçº§åŠ å¯†å­˜å‚¨
- **å®¡è®¡æ—¥å¿—**ï¼šæ‰€æœ‰å¥åº·æ•°æ®è®¿é—®è®°å½•
- **æƒé™æ§åˆ¶**ï¼šRBACåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶

---

## 2. ç³»ç»Ÿæ¶æ„æ¼”è¿›

### 2.1 MVPé˜¶æ®µæ¶æ„ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰

**æ¶æ„ç‰¹ç‚¹**ï¼šå•ä½“åº”ç”¨ + AIå¾®æœåŠ¡ï¼Œå¿«é€Ÿå¼€å‘ï¼Œä½æˆæœ¬è¿ç»´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®¢æˆ·ç«¯å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ æ‚£è€…ç«¯ (Uni-app)â”‚  â”‚ åŒ»ç”Ÿç«¯ (React) â”‚  â”‚ ç®¡ç†ç«¯ (React) â”‚     â”‚
â”‚  â”‚ å¾®ä¿¡å°ç¨‹åº/H5/Appâ”‚  â”‚     Webå“åº”å¼   â”‚  â”‚   åå°ç®¡ç†     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                   â”‚                â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚           Nginx åå‘ä»£ç†                     â”‚
          â”‚   - SSLç»ˆæ­¢  - é™æ€èµ„æº  - è´Ÿè½½å‡è¡¡         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚          åº”ç”¨æœåŠ¡å±‚ï¼ˆå•å°æœåŠ¡å™¨ï¼‰             â”‚
          â”‚                                            â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚   ä¸»æœåŠ¡ (NestJS å•ä½“åº”ç”¨)            â”‚ â”‚
          â”‚  â”‚   - ç”¨æˆ·æ¨¡å—                         â”‚ â”‚
          â”‚  â”‚   - å¥åº·ç®¡ç†æ¨¡å—                     â”‚ â”‚
          â”‚  â”‚   - ç§¯åˆ†æ¨¡å—                         â”‚ â”‚
          â”‚  â”‚   - é€šè®¯æ¨¡å— (Socket.io)             â”‚ â”‚
          â”‚  â”‚   - é€šçŸ¥æ¨¡å—                         â”‚ â”‚
          â”‚  â”‚   ç«¯å£: 3000                         â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â”‚                                            â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚   AIæœåŠ¡ (Python FastAPI)            â”‚ â”‚
          â”‚  â”‚   - DeepSeek APIè°ƒç”¨                 â”‚ â”‚
          â”‚  â”‚   - RAGçŸ¥è¯†åº“æ£€ç´¢                    â”‚ â”‚
          â”‚  â”‚   - AI Agentå¯¹è¯                     â”‚ â”‚
          â”‚  â”‚   ç«¯å£: 8000                         â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â”‚                                            â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚   EMQX (MQTT Broker)                 â”‚ â”‚
          â”‚  â”‚   - ç‰©è”ç½‘è®¾å¤‡æ¥å…¥                   â”‚ â”‚
          â”‚  â”‚   ç«¯å£: 1883                         â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚              æ•°æ®å±‚ï¼ˆåŒä¸€æœåŠ¡å™¨ï¼‰            â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚ PostgreSQL â”‚  â”‚ InfluxDB â”‚  â”‚ Qdrant â”‚ â”‚
          â”‚  â”‚   ä¸»æ•°æ®åº“  â”‚  â”‚  æ—¶åºåº“   â”‚  â”‚ å‘é‡åº“ â”‚ â”‚
          â”‚  â”‚   ç«¯å£5432  â”‚  â”‚  ç«¯å£8086 â”‚  â”‚ç«¯å£6333â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
          â”‚  â”‚   Redis    â”‚  â”‚  MinIO   â”‚             â”‚
          â”‚  â”‚  ç¼“å­˜/é˜Ÿåˆ—  â”‚  â”‚ å¯¹è±¡å­˜å‚¨ â”‚             â”‚
          â”‚  â”‚  ç«¯å£6379   â”‚  â”‚ ç«¯å£9000 â”‚             â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚            å¤–éƒ¨æœåŠ¡å±‚                        â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
          â”‚  â”‚DeepSeek  â”‚  â”‚ çŸ­ä¿¡æ¨é€ â”‚               â”‚
          â”‚  â”‚  API     â”‚  â”‚ (é˜¿é‡Œäº‘) â”‚               â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’° æˆæœ¬é¢„ä¼°ï¼š
- æœåŠ¡å™¨ï¼šé˜¿é‡Œäº‘ECS 4æ ¸8G (çº¦Â¥200/æœˆ)
- æ•°æ®åº“ï¼šè‡ªå»º (åŒ…å«åœ¨æœåŠ¡å™¨è´¹ç”¨ä¸­)
- å¯¹è±¡å­˜å‚¨ï¼šMinIOè‡ªå»º (çº¦Â¥50/æœˆ)
- AIè°ƒç”¨ï¼šDeepSeek API (æŒ‰é‡ä»˜è´¹ï¼Œçº¦Â¥500/æœˆ)
- æ€»è®¡ï¼šçº¦Â¥800-1000/æœˆ

ğŸ‘¥ å›¢é˜Ÿé…ç½®ï¼š
- 2å‰ç«¯ + 2åç«¯ + 1AIå·¥ç¨‹å¸ˆ = 5äºº
```

---

### 2.2 ä¼ä¸šçº§æ¶æ„ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰

**æ¶æ„ç‰¹ç‚¹**ï¼šå¾®æœåŠ¡é›†ç¾¤ + é«˜å¯ç”¨ + ç­‰ä¿ä¸‰çº§åˆè§„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®¢æˆ·ç«¯å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ æ‚£è€…ç«¯ (Uni-app)â”‚  â”‚ åŒ»ç”Ÿç«¯ (React) â”‚  â”‚ ç®¡ç†ç«¯ (React) â”‚     â”‚
â”‚  â”‚   å¤ç”¨MVPä»£ç    â”‚  â”‚  å¾®å‰ç«¯å¢å¼ºç‰ˆ   â”‚  â”‚  å¾®å‰ç«¯å¢å¼ºç‰ˆ   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                   â”‚                â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    APIç½‘å…³é›†ç¾¤ (Spring Cloud Gateway)       â”‚
          â”‚    - è·¯ç”±  - é™æµ  - ç†”æ–­  - é‰´æƒ           â”‚
          â”‚    - Sentinelæµé‡æ§åˆ¶                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚          å¾®æœåŠ¡é›†ç¾¤ (Kubernetes)             â”‚
          â”‚                                            â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
          â”‚  â”‚ç”¨æˆ·æœåŠ¡â”‚  â”‚å¥åº·æœåŠ¡â”‚  â”‚AIæœåŠ¡  â”‚       â”‚
          â”‚  â”‚Java 3å®â”‚  â”‚Java 3å®â”‚  â”‚Python  â”‚       â”‚
          â”‚  â”‚ä¾‹(Pod) â”‚  â”‚ä¾‹(Pod) â”‚  â”‚2å®ä¾‹   â”‚       â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
          â”‚                                            â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
          â”‚  â”‚é€šè®¯æœåŠ¡â”‚  â”‚ç§¯åˆ†æœåŠ¡â”‚  â”‚é€šçŸ¥æœåŠ¡â”‚       â”‚
          â”‚  â”‚Java 2å®â”‚  â”‚Java 2å®â”‚  â”‚Java 2å®â”‚       â”‚
          â”‚  â”‚ä¾‹      â”‚  â”‚ä¾‹      â”‚  â”‚ä¾‹      â”‚       â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
          â”‚                                            â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
          â”‚  â”‚  Nacos (æœåŠ¡æ³¨å†Œ/é…ç½®ä¸­å¿ƒ)          â”‚   â”‚
          â”‚  â”‚  RocketMQ (æ¶ˆæ¯é˜Ÿåˆ—)                â”‚   â”‚
          â”‚  â”‚  SkyWalking (é“¾è·¯è¿½è¸ª)              â”‚   â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚              æ•°æ®å±‚ï¼ˆå¤šæœåŠ¡å™¨é›†ç¾¤ï¼‰           â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
          â”‚  â”‚  MySQLä¸»ä»é›†ç¾¤ (è¯»å†™åˆ†ç¦»)             â”‚  â”‚
          â”‚  â”‚  - ä¸»åº“1å° + ä»åº“2å°                  â”‚  â”‚
          â”‚  â”‚  - ShardingSphereåˆ†åº“åˆ†è¡¨            â”‚  â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
          â”‚  â”‚  Redis Cluster (6èŠ‚ç‚¹)               â”‚  â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
          â”‚  â”‚  InfluxDB (ä¿æŒä¸å˜)                  â”‚  â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
          â”‚  â”‚  Milvus å‘é‡åº“é›†ç¾¤                    â”‚  â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚        ç›‘æ§ä¸è¿ç»´å±‚                          â”‚
          â”‚  Prometheus + Grafana (ç›‘æ§)               â”‚
          â”‚  ELK Stack (æ—¥å¿—)                          â”‚
          â”‚  SkyWalking (é“¾è·¯è¿½è¸ª)                     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’° æˆæœ¬é¢„ä¼°ï¼š
- æœåŠ¡å™¨é›†ç¾¤ï¼š10å°ECS (çº¦Â¥2000/æœˆ)
- RDSæ•°æ®åº“ï¼šMySQLè¯»å†™åˆ†ç¦» (çº¦Â¥1500/æœˆ)
- Redisé›†ç¾¤ï¼šé˜¿é‡Œäº‘ç‰ˆ (çº¦Â¥800/æœˆ)
- å¯¹è±¡å­˜å‚¨ï¼šOSS (çº¦Â¥300/æœˆ)
- K8sæ‰˜ç®¡ï¼šACK (çº¦Â¥500/æœˆ)
- AIè°ƒç”¨ï¼šDeepSeek (çº¦Â¥2000/æœˆ)
- ç›‘æ§æ—¥å¿—ï¼šçº¦Â¥500/æœˆ
- æ€»è®¡ï¼šçº¦Â¥7500-8500/æœˆ

ğŸ‘¥ å›¢é˜Ÿé…ç½®ï¼š
- 3å‰ç«¯ + 5åç«¯ + 2AI + 1DevOps = 11äºº
```

---

### 2.3 æ¶æ„æ¼”è¿›å¯¹æ¯”æ€»ç»“

| å¯¹æ¯”ç»´åº¦ | MVPé˜¶æ®µ | ä¼ä¸šçº§é˜¶æ®µ |
|---------|---------|-----------|
| **å¹¶å‘èƒ½åŠ›** | æ”¯æŒ1000äººåŒæ—¶åœ¨çº¿ | æ”¯æŒ10ä¸‡+äººåŒæ—¶åœ¨çº¿ |
| **å¯ç”¨æ€§** | å•ç‚¹æ•…éšœé£é™© | 99.9%å¯ç”¨æ€§ä¿è¯ |
| **æ•°æ®å®¹é‡** | æ”¯æŒ10ä¸‡æ¡è®°å½• | æ”¯æŒäº¿çº§è®°å½•ï¼Œåˆ†åº“åˆ†è¡¨ |
| **å¼€å‘å‘¨æœŸ** | 3-4ä¸ªæœˆä¸Šçº¿ | 6-8ä¸ªæœˆå®Œæˆè¿ç§» |
| **æœˆæˆæœ¬** | Â¥800-1000 | Â¥7500-8500 |
| **å›¢é˜Ÿè§„æ¨¡** | 5äºº | 11äºº |
| **æ‰©å±•æ€§** | å‚ç›´æ‰©å±•ï¼ˆå‡çº§æœåŠ¡å™¨ï¼‰ | æ°´å¹³æ‰©å±•ï¼ˆå¢åŠ èŠ‚ç‚¹ï¼‰ |
| **åˆè§„æ€§** | åŸºç¡€å®‰å…¨ | ç­‰ä¿ä¸‰çº§è®¤è¯ |

### 2.2 å¾®æœåŠ¡åˆ’åˆ†

#### 2.2.1 ç”¨æˆ·æœåŠ¡ï¼ˆUser Serviceï¼‰
- **èŒè´£**ï¼šç”¨æˆ·è®¤è¯ã€æˆæƒã€è§’è‰²ç®¡ç†ã€ä¸ªäººä¿¡æ¯ç®¡ç†
- **ç«¯å£**ï¼š3001
- **æ•°æ®åº“**ï¼šPostgreSQLï¼ˆusers, roles, permissionsè¡¨ï¼‰
- **å…³é”®æ¥å£**ï¼š
  - `POST /auth/register` - ç”¨æˆ·æ³¨å†Œ
  - `POST /auth/login` - ç”¨æˆ·ç™»å½•
  - `GET /users/:id` - è·å–ç”¨æˆ·ä¿¡æ¯
  - `PUT /users/:id` - æ›´æ–°ç”¨æˆ·ä¿¡æ¯

#### 2.2.2 å¥åº·æœåŠ¡ï¼ˆHealth Serviceï¼‰
- **èŒè´£**ï¼šå¥åº·æ¡£æ¡ˆã€æ‰“å¡è®°å½•ã€é£é™©è¯„ä¼°ã€å¥åº·æ•°æ®åˆ†æ
- **ç«¯å£**ï¼š3002
- **æ•°æ®åº“**ï¼šPostgreSQLï¼ˆhealth_records, check_ins, assessmentsè¡¨ï¼‰
- **å…³é”®æ¥å£**ï¼š
  - `POST /health/records` - åˆ›å»ºå¥åº·æ¡£æ¡ˆ
  - `POST /health/check-ins` - æäº¤æ‰“å¡æ•°æ®
  - `POST /health/assessments` - è¿›è¡Œé£é™©è¯„ä¼°
  - `GET /health/records/:userId` - è·å–ç”¨æˆ·å¥åº·æ¡£æ¡ˆ
  - `GET /health/check-ins/:userId/trends` - è·å–æ‰“å¡è¶‹åŠ¿

#### 2.2.3 AIæœåŠ¡ï¼ˆAI Serviceï¼‰
- **èŒè´£**ï¼šAIæ¨¡å‹é›†æˆã€å¥åº·ç§‘æ™®ã€æ™ºèƒ½å¯¹è¯ã€è¾…åŠ©è¯Šæ–­
- **ç«¯å£**ï¼š3003
- **æ•°æ®åº“**ï¼šMongoDBï¼ˆai_conversations, ai_logsè¡¨ï¼‰+ Qdrantï¼ˆå‘é‡æ£€ç´¢ï¼‰
- **å…³é”®æ¥å£**ï¼š
  - `POST /ai/chat` - AIå¯¹è¯
  - `POST /ai/health-advice` - å¥åº·å»ºè®®ç”Ÿæˆ
  - `POST /ai/diagnosis-assist` - è¾…åŠ©è¯Šæ–­
  - `GET /ai/popular-science` - ç§‘æ™®å†…å®¹æ¨è
  - `POST /ai/config` - é…ç½®AIæ¨¡å‹å‚æ•°

#### 2.2.4 é€šè®¯æœåŠ¡ï¼ˆCommunication Serviceï¼‰
- **èŒè´£**ï¼šå³æ—¶é€šè®¯ã€åŒ»æ‚£æ²Ÿé€šã€å¸ˆæ‚£æ²Ÿé€šã€æ¶ˆæ¯é€šçŸ¥
- **ç«¯å£**ï¼š3004
- **æ•°æ®åº“**ï¼šMongoDBï¼ˆmessagesè¡¨ï¼‰+ Redisï¼ˆåœ¨çº¿çŠ¶æ€ï¼‰
- **æŠ€æœ¯**ï¼šSocket.ioï¼ˆWebSocketå®æ—¶é€šä¿¡ï¼‰
- **å…³é”®æ¥å£**ï¼š
  - `WebSocket /chat` - å®æ—¶èŠå¤©è¿æ¥
  - `GET /messages/:conversationId` - è·å–èŠå¤©è®°å½•
  - `POST /messages/send` - å‘é€æ¶ˆæ¯
  - `GET /conversations/:userId` - è·å–ä¼šè¯åˆ—è¡¨

#### 2.2.5 ç§¯åˆ†æœåŠ¡ï¼ˆPoints Serviceï¼‰
- **èŒè´£**ï¼šç§¯åˆ†è®¡ç®—ã€ç§¯åˆ†äº¤æ˜“ã€ç¤¼å“å…‘æ¢ã€æ’è¡Œæ¦œ
- **ç«¯å£**ï¼š3005
- **æ•°æ®åº“**ï¼šPostgreSQLï¼ˆpoints_transactions, giftsè¡¨ï¼‰+ Redisï¼ˆæ’è¡Œæ¦œç¼“å­˜ï¼‰
- **å…³é”®æ¥å£**ï¼š
  - `POST /points/earn` - è·å¾—ç§¯åˆ†
  - `POST /points/redeem` - ç§¯åˆ†å…‘æ¢
  - `GET /points/balance/:userId` - æŸ¥è¯¢ç§¯åˆ†ä½™é¢
  - `GET /points/leaderboard` - è·å–æ’è¡Œæ¦œ

#### 2.2.6 é€šçŸ¥æœåŠ¡ï¼ˆNotification Serviceï¼‰
- **èŒè´£**ï¼šæ¨é€é€šçŸ¥ã€çŸ­ä¿¡æé†’ã€é‚®ä»¶æé†’ã€ä»»åŠ¡è°ƒåº¦
- **ç«¯å£**ï¼š3006
- **æ•°æ®åº“**ï¼šPostgreSQLï¼ˆnotificationsè¡¨ï¼‰+ Redisï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼‰
- **æŠ€æœ¯**ï¼šBullé˜Ÿåˆ—ã€FCM/APNsï¼ˆç§»åŠ¨æ¨é€ï¼‰
- **å…³é”®æ¥å£**ï¼š
  - `POST /notifications/push` - å‘é€æ¨é€é€šçŸ¥
  - `POST /notifications/schedule` - å®šæ—¶æé†’
  - `GET /notifications/:userId` - è·å–é€šçŸ¥åˆ—è¡¨
  - `PUT /notifications/:id/read` - æ ‡è®°å·²è¯»

#### 2.2.7 æ•°æ®åˆ†ææœåŠ¡ï¼ˆAnalytics Serviceï¼‰
- **èŒè´£**ï¼šæ•°æ®ç»Ÿè®¡ã€å¯è§†åŒ–ã€æŠ¥è¡¨ç”Ÿæˆ
- **ç«¯å£**ï¼š3007
- **æ•°æ®åº“**ï¼šPostgreSQLï¼ˆè¯»å‰¯æœ¬ï¼‰+ Redisï¼ˆç¼“å­˜ï¼‰
- **å…³é”®æ¥å£**ï¼š
  - `GET /analytics/dashboard` - ä»ªè¡¨ç›˜æ•°æ®
  - `GET /analytics/patient-stats` - æ‚£è€…ç»Ÿè®¡
  - `POST /analytics/export` - å¯¼å‡ºæŠ¥è¡¨

### 2.3 æ•°æ®æµæ¶æ„

#### 2.3.1 ç”¨æˆ·æ‰“å¡æµç¨‹
```
æ‚£è€…App â†’ APIç½‘å…³ â†’ å¥åº·æœåŠ¡ â†’ PostgreSQL
                  â†“
              ç§¯åˆ†æœåŠ¡ â†’ Redisæ›´æ–°ç§¯åˆ†
                  â†“
              é€šçŸ¥æœåŠ¡ â†’ æ¨é€æ‰“å¡æˆåŠŸé€šçŸ¥
```

#### 2.3.2 AIå¯¹è¯æµç¨‹
```
æ‚£è€…ç«¯ â†’ APIç½‘å…³ â†’ AIæœåŠ¡ â†’ DeepSeek API
                          â†“
                    å‘é‡æ•°æ®åº“æ£€ç´¢ä¸Šä¸‹æ–‡
                          â†“
                    MongoDBä¿å­˜å¯¹è¯å†å²
                          â†“
              è¿”å›AIå›å¤ â†’ æ‚£è€…ç«¯
```

#### 2.3.3 é£é™©è¯„ä¼°ä¸é¢„è­¦æµç¨‹
```
å®šæ—¶ä»»åŠ¡ â†’ å¥åº·æœåŠ¡è¯»å–æ‚£è€…æ•°æ®
              â†“
          AIæœåŠ¡åˆ†æé¢„æµ‹
              â†“
         æ£€æµ‹åˆ°é«˜é£é™©
              â†“
      é€šçŸ¥æœåŠ¡ â†’ æ¨é€ç»™æ‚£è€…/åŒ»ç”Ÿ/ç®¡ç†å¸ˆ
```

---

## 3. æ ¸å¿ƒç»„ä»¶ä¸æ¥å£

### 3.1 è®¤è¯æˆæƒç»„ä»¶

#### 3.1.1 JWTè®¤è¯æµç¨‹
```typescript
// ç™»å½•æµç¨‹
1. ç”¨æˆ·æäº¤è´¦å·å¯†ç 
2. ç”¨æˆ·æœåŠ¡éªŒè¯å‡­æ®
3. ç”ŸæˆJWT Tokenï¼ˆåŒ…å«ç”¨æˆ·IDã€è§’è‰²ã€è¿‡æœŸæ—¶é—´ï¼‰
4. è¿”å›Access Tokenï¼ˆ15åˆ†é’Ÿè¿‡æœŸï¼‰å’ŒRefresh Tokenï¼ˆ7å¤©è¿‡æœŸï¼‰
5. å®¢æˆ·ç«¯å­˜å‚¨Tokenï¼Œåç»­è¯·æ±‚æºå¸¦Authorization Header
6. APIç½‘å…³éªŒè¯Tokenï¼Œæå–ç”¨æˆ·ä¿¡æ¯
7. é€šè¿‡åè½¬å‘åˆ°ä¸šåŠ¡æœåŠ¡

// Tokenç»“æ„
{
  "sub": "user_id",
  "role": "patient" | "doctor" | "health_manager" | "admin",
  "permissions": ["read:health", "write:health"],
  "iat": 1234567890,
  "exp": 1234567890
}
```

#### 3.1.2 RBACæƒé™æ¨¡å‹
```typescript
// è§’è‰²å®šä¹‰
enum Role {
  PATIENT = 'patient',           // æ‚£è€…
  DOCTOR = 'doctor',             // åŒ»ç”Ÿ
  HEALTH_MANAGER = 'health_manager', // å¥åº·ç®¡ç†å¸ˆ
  ADMIN = 'admin'                // ç®¡ç†å‘˜
}

// æƒé™å®šä¹‰
enum Permission {
  // å¥åº·æ•°æ®
  READ_OWN_HEALTH = 'read:own_health',
  WRITE_OWN_HEALTH = 'write:own_health',
  READ_PATIENT_HEALTH = 'read:patient_health',

  // ç”¨æˆ·ç®¡ç†
  MANAGE_PATIENTS = 'manage:patients',
  MANAGE_USERS = 'manage:users',

  // AIåŠŸèƒ½
  USE_AI_CHAT = 'use:ai_chat',
  ACCESS_AI_DIAGNOSIS = 'access:ai_diagnosis',

  // ç³»ç»Ÿé…ç½®
  CONFIGURE_SYSTEM = 'configure:system',
  VIEW_ANALYTICS = 'view:analytics'
}

// è§’è‰²æƒé™æ˜ å°„
const rolePermissions = {
  [Role.PATIENT]: [
    Permission.READ_OWN_HEALTH,
    Permission.WRITE_OWN_HEALTH,
    Permission.USE_AI_CHAT
  ],
  [Role.DOCTOR]: [
    Permission.READ_PATIENT_HEALTH,
    Permission.MANAGE_PATIENTS,
    Permission.ACCESS_AI_DIAGNOSIS
  ],
  [Role.HEALTH_MANAGER]: [
    Permission.READ_PATIENT_HEALTH,
    Permission.MANAGE_PATIENTS,
    Permission.USE_AI_CHAT
  ],
  [Role.ADMIN]: Object.values(Permission) // æ‰€æœ‰æƒé™
}
```

### 3.2 AIé›†æˆç»„ä»¶

#### 3.2.1 AIæœåŠ¡é€‚é…å™¨æ¨¡å¼
```typescript
// AI ProvideræŠ½è±¡æ¥å£
interface AIProvider {
  chat(messages: Message[], options?: ChatOptions): Promise<ChatResponse>;
  embeddings(text: string): Promise<number[]>;
  healthAdvice(patientData: PatientData): Promise<HealthAdvice>;
}

// DeepSeekå®ç°
class DeepSeekProvider implements AIProvider {
  private apiKey: string;
  private baseURL: string;

  async chat(messages: Message[], options?: ChatOptions): Promise<ChatResponse> {
    const response = await axios.post(`${this.baseURL}/chat/completions`, {
      model: options?.model || 'deepseek-chat',
      messages,
      temperature: options?.temperature || 0.7,
      max_tokens: options?.maxTokens || 2000
    }, {
      headers: { 'Authorization': `Bearer ${this.apiKey}` }
    });

    return {
      content: response.data.choices[0].message.content,
      usage: response.data.usage
    };
  }

  async healthAdvice(patientData: PatientData): Promise<HealthAdvice> {
    // æ„å»ºå¥åº·å»ºè®®æç¤ºè¯
    const prompt = this.buildHealthAdvicePrompt(patientData);
    const response = await this.chat([{ role: 'user', content: prompt }]);
    return this.parseHealthAdvice(response.content);
  }
}

// å¤šæ¨¡å‹ç®¡ç†å™¨
class AIModelManager {
  private providers: Map<string, AIProvider> = new Map();

  registerProvider(name: string, provider: AIProvider) {
    this.providers.set(name, provider);
  }

  getProvider(name: string): AIProvider {
    return this.providers.get(name) || this.providers.get('default');
  }
}
```

#### 3.2.2 RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æ¶æ„
```typescript
// çŸ¥è¯†åº“æ£€ç´¢ç»„ä»¶
class HealthKnowledgeBase {
  private vectorDB: QdrantClient;
  private collectionName = 'health_knowledge';

  // æ·»åŠ ç§‘æ™®æ–‡æ¡£
  async addDocument(doc: HealthDocument): Promise<void> {
    const embedding = await aiProvider.embeddings(doc.content);
    await this.vectorDB.upsert(this.collectionName, {
      id: doc.id,
      vector: embedding,
      payload: {
        title: doc.title,
        content: doc.content,
        category: doc.category,
        tags: doc.tags
      }
    });
  }

  // æ£€ç´¢ç›¸å…³çŸ¥è¯†
  async search(query: string, limit = 3): Promise<HealthDocument[]> {
    const queryEmbedding = await aiProvider.embeddings(query);
    const results = await this.vectorDB.search(this.collectionName, {
      vector: queryEmbedding,
      limit
    });

    return results.map(r => r.payload as HealthDocument);
  }
}

// AIå¥åº·ç§‘æ™®æœåŠ¡
class HealthEducationService {
  async answerQuestion(question: string, patientContext?: PatientData): Promise<string> {
    // 1. æ£€ç´¢ç›¸å…³çŸ¥è¯†
    const relevantDocs = await knowledgeBase.search(question);

    // 2. æ„å»ºå¢å¼ºæç¤ºè¯
    const context = relevantDocs.map(d => d.content).join('\n\n');
    const prompt = `
      åŸºäºä»¥ä¸‹åŒ»å­¦çŸ¥è¯†å›ç­”æ‚£è€…é—®é¢˜ï¼š

      çŸ¥è¯†åº“å†…å®¹ï¼š
      ${context}

      æ‚£è€…é—®é¢˜ï¼š${question}

      ${patientContext ? `æ‚£è€…èƒŒæ™¯ï¼š${JSON.stringify(patientContext)}` : ''}

      è¯·ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€å›ç­”ï¼Œå¹¶åœ¨æœ€åæé†’æ‚£è€…"æ­¤å»ºè®®ä»…ä¾›å‚è€ƒï¼Œè¯·å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿ"ã€‚
    `;

    // 3. è°ƒç”¨AIç”Ÿæˆå›ç­”
    const response = await aiProvider.chat([
      { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¥åº·ç§‘æ™®åŠ©æ‰‹' },
      { role: 'user', content: prompt }
    ]);

    return response.content;
  }
}
```

#### 3.2.3 AI Agentå¯¹è¯ç®¡ç†
```typescript
// å¯¹è¯çŠ¶æ€ç®¡ç†
interface ConversationState {
  conversationId: string;
  userId: string;
  messages: Message[];
  context: {
    currentTask?: 'check_in' | 'health_question' | 'symptom_report';
    pendingData?: Record<string, any>;
  };
}

// AI Agentæ§åˆ¶å™¨
class AIAgentController {
  private conversations: Map<string, ConversationState> = new Map();

  async handleMessage(userId: string, message: string): Promise<string> {
    // 1. è·å–æˆ–åˆ›å»ºå¯¹è¯çŠ¶æ€
    let conversation = this.conversations.get(userId);
    if (!conversation) {
      conversation = this.createConversation(userId);
    }

    // 2. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    conversation.messages.push({ role: 'user', content: message });

    // 3. æ„å›¾è¯†åˆ«
    const intent = await this.detectIntent(message);

    // 4. æ ¹æ®æ„å›¾å¤„ç†
    let response: string;
    switch (intent.type) {
      case 'check_in':
        response = await this.handleCheckIn(conversation, intent.data);
        break;
      case 'health_question':
        response = await healthEducationService.answerQuestion(message);
        break;
      case 'symptom_report':
        response = await this.handleSymptomReport(conversation, intent.data);
        break;
      default:
        response = await this.chatWithAI(conversation);
    }

    // 5. ä¿å­˜å¯¹è¯å†å²
    conversation.messages.push({ role: 'assistant', content: response });
    await this.saveConversation(conversation);

    return response;
  }

  private async detectIntent(message: string): Promise<Intent> {
    // ä½¿ç”¨AIè¿›è¡Œæ„å›¾è¯†åˆ«
    const prompt = `
      åˆ†æç”¨æˆ·æ¶ˆæ¯çš„æ„å›¾ï¼Œè¿”å›JSONæ ¼å¼ï¼š
      {"type": "check_in|health_question|symptom_report|chat", "data": {...}}

      ç”¨æˆ·æ¶ˆæ¯ï¼š${message}
    `;

    const response = await aiProvider.chat([
      { role: 'system', content: 'ä½ æ˜¯æ„å›¾è¯†åˆ«åŠ©æ‰‹' },
      { role: 'user', content: prompt }
    ], { temperature: 0.1 });

    return JSON.parse(response.content);
  }

  private async handleCheckIn(conversation: ConversationState, data: any): Promise<string> {
    // ååŠ©ç”¨æˆ·å®Œæˆæ‰“å¡
    if (!data.bloodPressure) {
      return 'è¯·å‘Šè¯‰æˆ‘æ‚¨ä»Šå¤©çš„è¡€å‹æ•°å€¼ï¼ˆä¾‹å¦‚ï¼š120/80ï¼‰';
    }

    // ä¿å­˜æ‰“å¡æ•°æ®
    await healthService.createCheckIn({
      userId: conversation.userId,
      type: 'blood_pressure',
      value: data.bloodPressure,
      timestamp: new Date()
    });

    return 'è¡€å‹æ‰“å¡æˆåŠŸï¼æ‚¨è·å¾—äº†10ç§¯åˆ†ã€‚è¯·é—®è¿˜éœ€è¦è®°å½•å…¶ä»–å¥åº·æ•°æ®å—ï¼Ÿ';
  }
}
```

### 3.3 å®æ—¶é€šä¿¡ç»„ä»¶

#### 3.3.1 WebSocketæ¶æ„
```typescript
// Socket.ioæœåŠ¡ç«¯
class ChatSocketServer {
  private io: Server;

  initialize(httpServer: HttpServer) {
    this.io = new Server(httpServer, {
      cors: { origin: '*' },
      transports: ['websocket', 'polling']
    });

    // è®¤è¯ä¸­é—´ä»¶
    this.io.use(async (socket, next) => {
      const token = socket.handshake.auth.token;
      try {
        const user = await verifyToken(token);
        socket.data.user = user;
        next();
      } catch (err) {
        next(new Error('Authentication failed'));
      }
    });

    // è¿æ¥å¤„ç†
    this.io.on('connection', (socket) => {
      this.handleConnection(socket);
    });
  }

  private handleConnection(socket: Socket) {
    const userId = socket.data.user.id;

    // åŠ å…¥ç”¨æˆ·ä¸“å±æˆ¿é—´
    socket.join(`user:${userId}`);

    // æ›´æ–°åœ¨çº¿çŠ¶æ€
    redisClient.hset('online_users', userId, Date.now());

    // ç›‘å¬æ¶ˆæ¯å‘é€
    socket.on('send_message', async (data) => {
      await this.handleSendMessage(socket, data);
    });

    // æ–­å¼€è¿æ¥
    socket.on('disconnect', () => {
      redisClient.hdel('online_users', userId);
    });
  }

  private async handleSendMessage(socket: Socket, data: MessageData) {
    const { recipientId, content, type } = data;
    const senderId = socket.data.user.id;

    // ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
    const message = await messageRepository.create({
      senderId,
      recipientId,
      content,
      type,
      timestamp: new Date()
    });

    // å®æ—¶æ¨é€ç»™æ¥æ”¶è€…
    this.io.to(`user:${recipientId}`).emit('new_message', message);

    // å‘é€é€šçŸ¥
    await notificationService.pushNotification(recipientId, {
      title: 'æ–°æ¶ˆæ¯',
      body: content,
      data: { messageId: message.id }
    });
  }
}
```

### 3.4 æ–‡ä»¶å­˜å‚¨ç»„ä»¶

#### 3.4.1 OSSå­˜å‚¨æœåŠ¡
```typescript
class FileStorageService {
  private ossClient: OSS;
  private bucketName = 'health-mgmt';

  async uploadHealthDocument(
    file: Buffer,
    userId: string,
    fileName: string
  ): Promise<string> {
    // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
    const fileExt = path.extname(fileName);
    const uniqueName = `health_docs/${userId}/${Date.now()}${fileExt}`;

    // ä¸Šä¼ åˆ°OSS
    await this.ossClient.put(uniqueName, file, {
      headers: {
        'Content-Type': this.getContentType(fileExt),
        'x-oss-object-acl': 'private' // ç§æœ‰è®¿é—®
      }
    });

    // è¿”å›è®¿é—®URLï¼ˆå¸¦ç­¾åï¼Œ1å°æ—¶è¿‡æœŸï¼‰
    const url = this.ossClient.signatureUrl(uniqueName, {
      expires: 3600
    });

    return url;
  }

  async getSignedUrl(filePath: string): Promise<string> {
    return this.ossClient.signatureUrl(filePath, { expires: 3600 });
  }
}
```

---

## 4. æ•°æ®æ¨¡å‹

### 4.1 æ ¸å¿ƒæ•°æ®è¡¨è®¾è®¡

#### 4.1.1 ç”¨æˆ·è¡¨ï¼ˆusersï¼‰
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  email VARCHAR(100) UNIQUE,
  phone VARCHAR(20) UNIQUE,
  role VARCHAR(20) NOT NULL, -- patient, doctor, health_manager, admin

  -- ä¸ªäººä¿¡æ¯
  full_name VARCHAR(100),
  gender VARCHAR(10),
  birth_date DATE,
  id_card_encrypted TEXT, -- åŠ å¯†å­˜å‚¨èº«ä»½è¯å·
  avatar_url TEXT,

  -- çŠ¶æ€
  status VARCHAR(20) DEFAULT 'active', -- active, inactive, banned
  email_verified BOOLEAN DEFAULT false,
  phone_verified BOOLEAN DEFAULT false,

  -- æ—¶é—´æˆ³
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_login_at TIMESTAMP,

  -- ç´¢å¼•
  INDEX idx_role (role),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at)
);
```

#### 4.1.2 å¥åº·æ¡£æ¡ˆè¡¨ï¼ˆhealth_recordsï¼‰
```sql
CREATE TABLE health_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- åŸºç¡€ä¿¡æ¯
  height DECIMAL(5,2), -- èº«é«˜(cm)
  weight DECIMAL(5,2), -- ä½“é‡(kg)
  blood_type VARCHAR(5), -- è¡€å‹

  -- ç—…å²
  chronic_diseases JSONB, -- [{name: 'é«˜è¡€å‹', diagnosedAt: '2020-01-01'}]
  allergies JSONB, -- ['é’éœ‰ç´ ', 'èŠ±ç”Ÿ']
  family_history JSONB, -- å®¶æ—ç—…å²

  -- åŒ»ç–—æ–‡æ¡£
  documents JSONB, -- [{type: 'report', url: '...', uploadedAt: '...'}]

  -- æ—¶é—´æˆ³
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- ç´¢å¼•
  INDEX idx_user_id (user_id)
);
```

#### 4.1.3 æ‰“å¡è®°å½•è¡¨ï¼ˆcheck_insï¼‰
```sql
CREATE TABLE check_ins (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- æ‰“å¡ç±»å‹
  type VARCHAR(50) NOT NULL, -- blood_pressure, blood_sugar, medication, exercise, diet, therapy

  -- æ‰“å¡æ•°æ®ï¼ˆJSONæ ¼å¼å­˜å‚¨ä¸åŒç±»å‹çš„æ•°æ®ï¼‰
  data JSONB NOT NULL,
  -- ç¤ºä¾‹ï¼š
  -- è¡€å‹: {systolic: 120, diastolic: 80, pulse: 72}
  -- è¡€ç³–: {value: 5.5, timing: 'before_meal'}
  -- ç”¨è¯: {medication: 'é˜¿å¸åŒ¹æ—', dosage: '100mg', taken: true}
  -- è¿åŠ¨: {type: 'è·‘æ­¥', duration: 30, intensity: 'moderate'}
  -- é¥®é£Ÿ: {meal: 'æ—©é¤', items: ['ç‡•éº¦', 'é¸¡è›‹'], calories: 350}

  -- å¤‡æ³¨
  notes TEXT,

  -- ç§¯åˆ†å¥–åŠ±
  points_earned INT DEFAULT 0,

  -- æ—¶é—´
  check_in_date DATE NOT NULL, -- æ‰“å¡æ—¥æœŸ
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- ç´¢å¼•
  INDEX idx_user_date (user_id, check_in_date),
  INDEX idx_type (type),
  INDEX idx_created_at (created_at),

  -- å”¯ä¸€çº¦æŸï¼šæ¯å¤©æ¯ç§ç±»å‹åªèƒ½æ‰“å¡ä¸€æ¬¡
  UNIQUE (user_id, type, check_in_date)
);
```

#### 4.1.4 é£é™©è¯„ä¼°è¡¨ï¼ˆrisk_assessmentsï¼‰
```sql
CREATE TABLE risk_assessments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- è¯„ä¼°ç±»å‹
  type VARCHAR(50) NOT NULL, -- diabetes, stroke, vascular_age, heart_disease

  -- è¯„ä¼°æ•°æ®
  questionnaire_data JSONB, -- é—®å·å›ç­”
  device_data JSONB, -- è®¾å¤‡æ£€æµ‹æ•°æ®

  -- è¯„ä¼°ç»“æœ
  risk_level VARCHAR(20) NOT NULL, -- low, medium, high
  risk_score DECIMAL(5,2), -- é£é™©åˆ†æ•°(0-100)
  result_details JSONB, -- è¯¦ç»†ç»“æœ

  -- AIå»ºè®®
  ai_recommendations TEXT,

  -- æ—¶é—´
  assessed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- ç´¢å¼•
  INDEX idx_user_type (user_id, type),
  INDEX idx_risk_level (risk_level),
  INDEX idx_assessed_at (assessed_at)
);
```

#### 4.1.5 ç§¯åˆ†äº¤æ˜“è¡¨ï¼ˆpoints_transactionsï¼‰
```sql
CREATE TABLE points_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- äº¤æ˜“ç±»å‹
  type VARCHAR(20) NOT NULL, -- earn, redeem, bonus, penalty

  -- ç§¯åˆ†å˜åŒ–
  points INT NOT NULL, -- æ­£æ•°ä¸ºè·å¾—ï¼Œè´Ÿæ•°ä¸ºæ¶ˆè´¹

  -- æ¥æº/ç”¨é€”
  source VARCHAR(50), -- check_in, continuous_streak, gift_redemption
  source_id UUID, -- å…³è”IDï¼ˆæ‰“å¡IDã€ç¤¼å“IDç­‰ï¼‰

  -- æè¿°
  description TEXT,

  -- æ—¶é—´
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- ç´¢å¼•
  INDEX idx_user_created (user_id, created_at),
  INDEX idx_type (type)
);

-- ç§¯åˆ†ä½™é¢è§†å›¾
CREATE VIEW user_points_balance AS
SELECT
  user_id,
  SUM(points) as balance
FROM points_transactions
GROUP BY user_id;
```

#### 4.1.6 åŒ»æ‚£å…³ç³»è¡¨ï¼ˆdoctor_patient_relationsï¼‰
```sql
CREATE TABLE doctor_patient_relations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  doctor_id UUID NOT NULL REFERENCES users(id),
  patient_id UUID NOT NULL REFERENCES users(id),

  -- å…³ç³»çŠ¶æ€
  status VARCHAR(20) DEFAULT 'active', -- active, inactive

  -- å¤‡æ³¨
  notes TEXT,

  -- æ—¶é—´
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- ç´¢å¼•
  INDEX idx_doctor (doctor_id),
  INDEX idx_patient (patient_id),
  UNIQUE (doctor_id, patient_id)
);
```

#### 4.1.7 å¥åº·ç®¡ç†å¸ˆä¼šå‘˜å…³ç³»è¡¨ï¼ˆmanager_member_relationsï¼‰
```sql
CREATE TABLE manager_member_relations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  manager_id UUID NOT NULL REFERENCES users(id),
  member_id UUID NOT NULL REFERENCES users(id),

  -- ä¼šå‘˜ç±»å‹
  membership_type VARCHAR(50), -- basic, premium, vip

  -- ç®¡ç†æ—¶é•¿ç»Ÿè®¡
  service_count INT DEFAULT 0,
  total_service_hours DECIMAL(10,2) DEFAULT 0,

  -- çŠ¶æ€
  status VARCHAR(20) DEFAULT 'active',

  -- æ—¶é—´
  started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  ended_at TIMESTAMP,

  -- ç´¢å¼•
  INDEX idx_manager (manager_id),
  INDEX idx_member (member_id),
  UNIQUE (manager_id, member_id)
);
```

#### 4.1.8 æ¶ˆæ¯è¡¨ï¼ˆmessages - MongoDBï¼‰
```javascript
// MongoDBé›†åˆç»“æ„
{
  _id: ObjectId,
  conversationId: String, // ä¼šè¯ID
  senderId: String, // å‘é€è€…UUID
  recipientId: String, // æ¥æ”¶è€…UUID

  // æ¶ˆæ¯å†…å®¹
  type: String, // text, image, voice, video, file
  content: String, // æ–‡æœ¬å†…å®¹æˆ–æ–‡ä»¶URL
  metadata: {
    fileName: String,
    fileSize: Number,
    duration: Number // è¯­éŸ³/è§†é¢‘æ—¶é•¿
  },

  // çŠ¶æ€
  status: String, // sent, delivered, read
  readAt: Date,

  // æ—¶é—´
  createdAt: Date,

  // ç´¢å¼•
  indexes: [
    { conversationId: 1, createdAt: -1 },
    { senderId: 1, createdAt: -1 },
    { recipientId: 1, status: 1 }
  ]
}
```

#### 4.1.9 AIå¯¹è¯å†å²è¡¨ï¼ˆai_conversations - MongoDBï¼‰
```javascript
{
  _id: ObjectId,
  userId: String,
  conversationId: String,

  // å¯¹è¯æ¶ˆæ¯
  messages: [
    {
      role: String, // user, assistant, system
      content: String,
      timestamp: Date
    }
  ],

  // ä¸Šä¸‹æ–‡
  context: {
    task: String, // check_in, health_question, symptom_report
    pendingData: Object
  },

  // å…ƒæ•°æ®
  metadata: {
    modelUsed: String, // deepseek-chat
    totalTokens: Number,
    cost: Number
  },

  // æ—¶é—´
  createdAt: Date,
  updatedAt: Date,

  indexes: [
    { userId: 1, createdAt: -1 },
    { conversationId: 1 }
  ]
}
```

### 4.2 æ•°æ®å…³ç³»å›¾

```mermaid
erDiagram
    users ||--o{ health_records : "has"
    users ||--o{ check_ins : "creates"
    users ||--o{ risk_assessments : "takes"
    users ||--o{ points_transactions : "earns/spends"
    users ||--o{ doctor_patient_relations : "participates"
    users ||--o{ manager_member_relations : "participates"

    users {
        uuid id PK
        string username
        string role
        string full_name
        timestamp created_at
    }

    health_records {
        uuid id PK
        uuid user_id FK
        decimal height
        decimal weight
        jsonb chronic_diseases
    }

    check_ins {
        uuid id PK
        uuid user_id FK
        string type
        jsonb data
        date check_in_date
    }

    risk_assessments {
        uuid id PK
        uuid user_id FK
        string type
        string risk_level
        decimal risk_score
    }
```

---

## 5. é”™è¯¯å¤„ç†

### 5.1 é”™è¯¯åˆ†ç±»ä¸ç¼–ç 

```typescript
// é”™è¯¯ä»£ç è§„èŒƒ
enum ErrorCode {
  // 1xxx - è®¤è¯æˆæƒé”™è¯¯
  UNAUTHORIZED = 1001,
  FORBIDDEN = 1002,
  TOKEN_EXPIRED = 1003,
  INVALID_CREDENTIALS = 1004,

  // 2xxx - ä¸šåŠ¡é€»è¾‘é”™è¯¯
  RESOURCE_NOT_FOUND = 2001,
  DUPLICATE_RESOURCE = 2002,
  INVALID_INPUT = 2003,
  CHECK_IN_ALREADY_EXISTS = 2004,
  INSUFFICIENT_POINTS = 2005,

  // 3xxx - å¤–éƒ¨æœåŠ¡é”™è¯¯
  AI_SERVICE_ERROR = 3001,
  OSS_UPLOAD_FAILED = 3002,
  SMS_SEND_FAILED = 3003,

  // 4xxx - ç³»ç»Ÿé”™è¯¯
  DATABASE_ERROR = 4001,
  INTERNAL_SERVER_ERROR = 4002,
  SERVICE_UNAVAILABLE = 4003
}

// ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
interface ErrorResponse {
  success: false;
  error: {
    code: ErrorCode;
    message: string;
    details?: any;
    timestamp: string;
    requestId: string;
  };
}

// è‡ªå®šä¹‰å¼‚å¸¸ç±»
class AppError extends Error {
  constructor(
    public code: ErrorCode,
    public message: string,
    public statusCode: number = 400,
    public details?: any
  ) {
    super(message);
  }
}
```

### 5.2 å…¨å±€å¼‚å¸¸å¤„ç†å™¨

```typescript
// NestJSå…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  catch(exception: any, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    const request = ctx.getRequest();

    let errorResponse: ErrorResponse;

    if (exception instanceof AppError) {
      // è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸
      errorResponse = {
        success: false,
        error: {
          code: exception.code,
          message: exception.message,
          details: exception.details,
          timestamp: new Date().toISOString(),
          requestId: request.id
        }
      };
      response.status(exception.statusCode).json(errorResponse);
    } else if (exception instanceof HttpException) {
      // HTTPå¼‚å¸¸
      const status = exception.getStatus();
      errorResponse = {
        success: false,
        error: {
          code: this.mapHttpStatusToErrorCode(status),
          message: exception.message,
          timestamp: new Date().toISOString(),
          requestId: request.id
        }
      };
      response.status(status).json(errorResponse);
    } else {
      // æœªçŸ¥å¼‚å¸¸
      logger.error('Unhandled exception', exception);
      errorResponse = {
        success: false,
        error: {
          code: ErrorCode.INTERNAL_SERVER_ERROR,
          message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
          timestamp: new Date().toISOString(),
          requestId: request.id
        }
      };
      response.status(500).json(errorResponse);
    }
  }
}
```

### 5.3 é‡è¯•ä¸ç†”æ–­ç­–ç•¥

```typescript
// AIæœåŠ¡è°ƒç”¨é‡è¯•è£…é¥°å™¨
function RetryOnFailure(maxRetries = 3, delay = 1000) {
  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor) {
    const originalMethod = descriptor.value;

    descriptor.value = async function (...args: any[]) {
      let lastError: Error;

      for (let i = 0; i < maxRetries; i++) {
        try {
          return await originalMethod.apply(this, args);
        } catch (error) {
          lastError = error;
          if (i < maxRetries - 1) {
            await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
          }
        }
      }

      throw new AppError(
        ErrorCode.AI_SERVICE_ERROR,
        `AIæœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œå·²é‡è¯•${maxRetries}æ¬¡`,
        503,
        { originalError: lastError.message }
      );
    };

    return descriptor;
  };
}

// ç†”æ–­å™¨å®ç°
class CircuitBreaker {
  private failureCount = 0;
  private successCount = 0;
  private state: 'CLOSED' | 'OPEN' | 'HALF_OPEN' = 'CLOSED';
  private nextAttempt: number = Date.now();

  constructor(
    private threshold: number = 5, // å¤±è´¥é˜ˆå€¼
    private timeout: number = 60000 // ç†”æ–­è¶…æ—¶(ms)
  ) {}

  async execute<T>(fn: () => Promise<T>): Promise<T> {
    if (this.state === 'OPEN') {
      if (Date.now() < this.nextAttempt) {
        throw new AppError(
          ErrorCode.SERVICE_UNAVAILABLE,
          'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•',
          503
        );
      }
      this.state = 'HALF_OPEN';
    }

    try {
      const result = await fn();
      this.onSuccess();
      return result;
    } catch (error) {
      this.onFailure();
      throw error;
    }
  }

  private onSuccess() {
    this.failureCount = 0;
    if (this.state === 'HALF_OPEN') {
      this.state = 'CLOSED';
    }
  }

  private onFailure() {
    this.failureCount++;
    if (this.failureCount >= this.threshold) {
      this.state = 'OPEN';
      this.nextAttempt = Date.now() + this.timeout;
    }
  }
}
```

---

## 6. æµ‹è¯•ç­–ç•¥

### 6.1 æµ‹è¯•é‡‘å­—å¡”

```
           /\
          /  \  E2Eæµ‹è¯• (10%)
         /â”€â”€â”€â”€\  - å…³é”®ä¸šåŠ¡æµç¨‹ç«¯åˆ°ç«¯æµ‹è¯•
        /      \
       /        \ é›†æˆæµ‹è¯• (30%)
      /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\ - APIæ¥å£æµ‹è¯•
     /            \ - æ•°æ®åº“é›†æˆæµ‹è¯•
    /              \ - å¤–éƒ¨æœåŠ¡Mockæµ‹è¯•
   /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\
  /                  \ å•å…ƒæµ‹è¯• (60%)
 /____________________\ - ä¸šåŠ¡é€»è¾‘å•å…ƒæµ‹è¯•
                         - å·¥å…·å‡½æ•°æµ‹è¯•
```

### 6.2 å•å…ƒæµ‹è¯•ç¤ºä¾‹

```typescript
// å¥åº·æ‰“å¡æœåŠ¡å•å…ƒæµ‹è¯•
describe('CheckInService', () => {
  let service: CheckInService;
  let repository: CheckInRepository;
  let pointsService: PointsService;

  beforeEach(() => {
    repository = mock<CheckInRepository>();
    pointsService = mock<PointsService>();
    service = new CheckInService(repository, pointsService);
  });

  describe('createCheckIn', () => {
    it('åº”è¯¥æˆåŠŸåˆ›å»ºè¡€å‹æ‰“å¡è®°å½•å¹¶å‘æ”¾ç§¯åˆ†', async () => {
      // Arrange
      const userId = 'user-123';
      const checkInData = {
        type: 'blood_pressure',
        data: { systolic: 120, diastolic: 80 },
        checkInDate: '2025-01-15'
      };

      repository.findByUserAndDate.mockResolvedValue(null);
      repository.create.mockResolvedValue({ id: 'check-in-1', ...checkInData });
      pointsService.earnPoints.mockResolvedValue({ points: 10 });

      // Act
      const result = await service.createCheckIn(userId, checkInData);

      // Assert
      expect(result.id).toBe('check-in-1');
      expect(pointsService.earnPoints).toHaveBeenCalledWith(
        userId,
        10,
        'check_in',
        'check-in-1'
      );
    });

    it('åº”è¯¥åœ¨é‡å¤æ‰“å¡æ—¶æŠ›å‡ºå¼‚å¸¸', async () => {
      // Arrange
      repository.findByUserAndDate.mockResolvedValue({ id: 'existing' });

      // Act & Assert
      await expect(
        service.createCheckIn('user-123', {
          type: 'blood_pressure',
          data: {},
          checkInDate: '2025-01-15'
        })
      ).rejects.toThrow(AppError);
    });
  });
});
```

### 6.3 é›†æˆæµ‹è¯•ç¤ºä¾‹

```typescript
// APIé›†æˆæµ‹è¯•
describe('Health API Integration Tests', () => {
  let app: INestApplication;
  let authToken: string;

  beforeAll(async () => {
    const moduleRef = await Test.createTestingModule({
      imports: [AppModule]
    }).compile();

    app = moduleRef.createNestApplication();
    await app.init();

    // ç™»å½•è·å–Token
    const loginResponse = await request(app.getHttpServer())
      .post('/auth/login')
      .send({ username: 'testuser', password: 'password123' });
    authToken = loginResponse.body.data.accessToken;
  });

  it('POST /health/check-ins åº”è¯¥åˆ›å»ºæ‰“å¡è®°å½•', async () => {
    const response = await request(app.getHttpServer())
      .post('/health/check-ins')
      .set('Authorization', `Bearer ${authToken}`)
      .send({
        type: 'blood_pressure',
        data: { systolic: 120, diastolic: 80 },
        checkInDate: '2025-01-15'
      })
      .expect(201);

    expect(response.body.success).toBe(true);
    expect(response.body.data.type).toBe('blood_pressure');
  });

  afterAll(async () => {
    await app.close();
  });
});
```

### 6.4 E2Eæµ‹è¯•ç¤ºä¾‹

```typescript
// ä½¿ç”¨Playwrightè¿›è¡ŒE2Eæµ‹è¯•
import { test, expect } from '@playwright/test';

test('æ‚£è€…å®Œæ•´æ‰“å¡æµç¨‹', async ({ page }) => {
  // 1. ç™»å½•
  await page.goto('http://localhost:3000/login');
  await page.fill('[name="username"]', 'patient@test.com');
  await page.fill('[name="password"]', 'password123');
  await page.click('button[type="submit"]');
  await expect(page).toHaveURL(/.*dashboard/);

  // 2. è¿›å…¥æ‰“å¡é¡µé¢
  await page.click('text=å¥åº·æ‰“å¡');
  await expect(page.locator('h1')).toContainText('å¥åº·æ‰“å¡');

  // 3. å¡«å†™è¡€å‹æ•°æ®
  await page.click('text=è¡€å‹æ‰“å¡');
  await page.fill('[name="systolic"]', '120');
  await page.fill('[name="diastolic"]', '80');
  await page.click('button:has-text("æäº¤")');

  // 4. éªŒè¯æˆåŠŸæç¤ºå’Œç§¯åˆ†å¢åŠ 
  await expect(page.locator('.success-message')).toContainText('æ‰“å¡æˆåŠŸ');
  await expect(page.locator('.points-display')).toContainText('+10');

  // 5. éªŒè¯æ—¥å†æ ‡è®°
  await page.goto('http://localhost:3000/calendar');
  const todayCell = page.locator('.calendar-cell.today');
  await expect(todayCell.locator('.check-mark')).toBeVisible();
});
```

### 6.5 AIåŠŸèƒ½æµ‹è¯•ç­–ç•¥

```typescript
// AIæœåŠ¡Mockæµ‹è¯•
describe('AI Health Advice', () => {
  let aiService: AIService;
  let mockProvider: jest.Mocked<AIProvider>;

  beforeEach(() => {
    mockProvider = {
      chat: jest.fn(),
      healthAdvice: jest.fn()
    } as any;

    aiService = new AIService(mockProvider);
  });

  it('åº”è¯¥åŸºäºæ‚£è€…æ•°æ®ç”Ÿæˆå¥åº·å»ºè®®', async () => {
    // Mock AIå“åº”
    mockProvider.healthAdvice.mockResolvedValue({
      advice: 'å»ºè®®æ§åˆ¶é¥®é£Ÿï¼Œå¢åŠ è¿åŠ¨',
      riskLevel: 'medium',
      actions: ['å‡å°‘ç›åˆ†æ‘„å…¥', 'æ¯æ—¥æ­¥è¡Œ30åˆ†é’Ÿ']
    });

    const patientData = {
      age: 45,
      checkIns: [
        { type: 'blood_pressure', data: { systolic: 145, diastolic: 90 } }
      ]
    };

    const advice = await aiService.generateHealthAdvice(patientData);

    expect(advice.advice).toBeDefined();
    expect(advice.riskLevel).toBe('medium');
    expect(mockProvider.healthAdvice).toHaveBeenCalledWith(patientData);
  });
});

// çœŸå®AIæ¥å£æµ‹è¯•ï¼ˆä»…åœ¨ç‰¹å®šç¯å¢ƒè¿è¡Œï¼‰
describe('Real AI Integration', () => {
  if (process.env.RUN_AI_TESTS !== 'true') {
    test.skip('è·³è¿‡çœŸå®AIæµ‹è¯•');
    return;
  }

  it('åº”è¯¥ä»DeepSeekè·å–çœŸå®å“åº”', async () => {
    const provider = new DeepSeekProvider(process.env.DEEPSEEK_API_KEY);
    const response = await provider.chat([
      { role: 'user', content: 'é«˜è¡€å‹æ‚£è€…åº”è¯¥æ³¨æ„ä»€ä¹ˆï¼Ÿ' }
    ]);

    expect(response.content).toBeTruthy();
    expect(response.content.length).toBeGreaterThan(50);
  }, 30000); // 30ç§’è¶…æ—¶
});
```

---

## 7. å®‰å…¨è®¾è®¡

### 7.1 æ•°æ®åŠ å¯†

```typescript
// æ•æ„Ÿå­—æ®µåŠ å¯†æœåŠ¡
class EncryptionService {
  private algorithm = 'aes-256-gcm';
  private key: Buffer;

  constructor(secretKey: string) {
    this.key = crypto.scryptSync(secretKey, 'salt', 32);
  }

  encrypt(text: string): string {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipheriv(this.algorithm, this.key, iv);

    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');

    const authTag = cipher.getAuthTag();

    // è¿”å›æ ¼å¼: iv:authTag:encrypted
    return `${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted}`;
  }

  decrypt(encryptedText: string): string {
    const [ivHex, authTagHex, encrypted] = encryptedText.split(':');

    const iv = Buffer.from(ivHex, 'hex');
    const authTag = Buffer.from(authTagHex, 'hex');
    const decipher = crypto.createDecipheriv(this.algorithm, this.key, iv);

    decipher.setAuthTag(authTag);

    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');

    return decrypted;
  }
}

// Prismaä¸­é—´ä»¶è‡ªåŠ¨åŠ å¯†è§£å¯†
prisma.$use(async (params, next) => {
  // åŠ å¯†æ•æ„Ÿå­—æ®µ
  if (params.action === 'create' || params.action === 'update') {
    if (params.model === 'User' && params.args.data.idCard) {
      params.args.data.idCardEncrypted = encryptionService.encrypt(
        params.args.data.idCard
      );
      delete params.args.data.idCard;
    }
  }

  const result = await next(params);

  // è§£å¯†æ•æ„Ÿå­—æ®µ
  if (params.model === 'User' && result?.idCardEncrypted) {
    result.idCard = encryptionService.decrypt(result.idCardEncrypted);
  }

  return result;
});
```

### 7.2 SQLæ³¨å…¥é˜²æŠ¤

```typescript
// ä½¿ç”¨Prisma ORMï¼Œè‡ªåŠ¨é˜²æ­¢SQLæ³¨å…¥
// âœ… å®‰å…¨çš„æŸ¥è¯¢
const user = await prisma.user.findUnique({
  where: { id: userId } // å‚æ•°åŒ–æŸ¥è¯¢
});

// âŒ é¿å…åŸå§‹SQLï¼ˆé™¤éå¿…è¦ï¼‰
// const users = await prisma.$queryRaw`SELECT * FROM users WHERE id = ${userId}`;
// å¦‚æœå¿…é¡»ä½¿ç”¨ï¼Œåº”ä½¿ç”¨Prisma.sqlæ¨¡æ¿æ ‡ç­¾

// âœ… å®‰å…¨çš„åŸå§‹æŸ¥è¯¢
const users = await prisma.$queryRaw`
  SELECT * FROM users WHERE id = ${Prisma.sql`${userId}`}
`;
```

### 7.3 XSSé˜²æŠ¤

```typescript
// è¾“å…¥éªŒè¯ä¸æ¸…ç†
import { sanitizeHtml } from 'sanitize-html';

class InputSanitizer {
  static sanitizeText(input: string): string {
    // ç§»é™¤HTMLæ ‡ç­¾å’Œè„šæœ¬
    return sanitizeHtml(input, {
      allowedTags: [], // ä¸å…è®¸ä»»ä½•HTMLæ ‡ç­¾
      allowedAttributes: {}
    });
  }

  static sanitizeRichText(input: string): string {
    // å…è®¸éƒ¨åˆ†å®‰å…¨çš„HTMLæ ‡ç­¾ï¼ˆå¦‚ç§‘æ™®æ–‡ç« ï¼‰
    return sanitizeHtml(input, {
      allowedTags: ['p', 'br', 'strong', 'em', 'ul', 'ol', 'li'],
      allowedAttributes: {}
    });
  }
}

// DTOéªŒè¯
class CreateCheckInDto {
  @IsEnum(['blood_pressure', 'blood_sugar', 'medication', 'exercise', 'diet'])
  type: string;

  @ValidateNested()
  @Type(() => CheckInDataDto)
  data: CheckInDataDto;

  @IsOptional()
  @IsString()
  @MaxLength(500)
  @Transform(({ value }) => InputSanitizer.sanitizeText(value))
  notes?: string;
}
```

### 7.4 è®¿é—®æ§åˆ¶

```typescript
// åŸºäºRBACçš„æƒé™å®ˆå«
@Injectable()
export class PermissionsGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const requiredPermissions = this.reflector.get<Permission[]>(
      'permissions',
      context.getHandler()
    );

    if (!requiredPermissions) {
      return true;
    }

    const request = context.switchToHttp().getRequest();
    const user = request.user;

    const userPermissions = rolePermissions[user.role] || [];

    return requiredPermissions.every(permission =>
      userPermissions.includes(permission)
    );
  }
}

// ä½¿ç”¨ç¤ºä¾‹
@Controller('health')
export class HealthController {
  @Get('records/:patientId')
  @UseGuards(JwtAuthGuard, PermissionsGuard)
  @Permissions(Permission.READ_PATIENT_HEALTH)
  async getPatientRecords(@Param('patientId') patientId: string, @User() user) {
    // é¢å¤–æ£€æŸ¥ï¼šåŒ»ç”Ÿåªèƒ½æŸ¥çœ‹è‡ªå·±ç®¡ç†çš„æ‚£è€…
    if (user.role === Role.DOCTOR) {
      const hasAccess = await this.checkDoctorPatientRelation(user.id, patientId);
      if (!hasAccess) {
        throw new ForbiddenException('æ— æƒè®¿é—®æ­¤æ‚£è€…æ•°æ®');
      }
    }

    return this.healthService.getRecords(patientId);
  }
}
```

### 7.5 å®¡è®¡æ—¥å¿—

```typescript
// å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  action VARCHAR(50) NOT NULL, -- read, create, update, delete
  resource_type VARCHAR(50) NOT NULL, -- health_record, user, etc.
  resource_id UUID,
  ip_address VARCHAR(50),
  user_agent TEXT,
  request_data JSONB,
  response_status INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX idx_user_action (user_id, action, created_at),
  INDEX idx_resource (resource_type, resource_id)
);

// å®¡è®¡æ—¥å¿—ä¸­é—´ä»¶
@Injectable()
export class AuditLogMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    const startTime = Date.now();

    res.on('finish', async () => {
      if (this.shouldAudit(req)) {
        await auditLogRepository.create({
          userId: req.user?.id,
          action: this.mapMethodToAction(req.method),
          resourceType: this.extractResourceType(req.path),
          resourceId: req.params.id,
          ipAddress: req.ip,
          userAgent: req.headers['user-agent'],
          requestData: this.sanitizeRequestData(req.body),
          responseStatus: res.statusCode,
          duration: Date.now() - startTime
        });
      }
    });

    next();
  }

  private shouldAudit(req: Request): boolean {
    // ä»…å®¡è®¡æ•æ„Ÿæ“ä½œ
    return [
      '/health/records',
      '/users',
      '/ai/diagnosis-assist'
    ].some(path => req.path.includes(path));
  }
}
```

---

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 æ•°æ®åº“ä¼˜åŒ–

```typescript
// 1. ç´¢å¼•ä¼˜åŒ–
CREATE INDEX CONCURRENTLY idx_check_ins_user_date
ON check_ins(user_id, check_in_date DESC);

CREATE INDEX CONCURRENTLY idx_messages_conversation
ON messages(conversation_id, created_at DESC);

// 2. æŸ¥è¯¢ä¼˜åŒ– - ä½¿ç”¨åˆ†é¡µ
async function getCheckInHistory(userId: string, page = 1, limit = 20) {
  const offset = (page - 1) * limit;

  const [items, total] = await Promise.all([
    prisma.checkIn.findMany({
      where: { userId },
      orderBy: { checkInDate: 'desc' },
      take: limit,
      skip: offset
    }),
    prisma.checkIn.count({ where: { userId } })
  ]);

  return { items, total, page, totalPages: Math.ceil(total / limit) };
}

// 3. æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
async function getPatientListWithStats(doctorId: string) {
  // ä½¿ç”¨å•ä¸ªSQLæŸ¥è¯¢è·å–ç»Ÿè®¡æ•°æ®
  const patients = await prisma.$queryRaw`
    SELECT
      u.id, u.full_name, u.avatar_url,
      COUNT(DISTINCT c.id) as check_in_count,
      MAX(c.check_in_date) as last_check_in,
      AVG(CASE WHEN ra.risk_level = 'high' THEN 3
               WHEN ra.risk_level = 'medium' THEN 2
               ELSE 1 END) as avg_risk_score
    FROM users u
    JOIN doctor_patient_relations dpr ON u.id = dpr.patient_id
    LEFT JOIN check_ins c ON u.id = c.user_id
      AND c.check_in_date >= NOW() - INTERVAL '30 days'
    LEFT JOIN risk_assessments ra ON u.id = ra.user_id
      AND ra.assessed_at >= NOW() - INTERVAL '90 days'
    WHERE dpr.doctor_id = ${doctorId} AND dpr.status = 'active'
    GROUP BY u.id, u.full_name, u.avatar_url
    ORDER BY avg_risk_score DESC
  `;

  return patients;
}
```

### 8.2 ç¼“å­˜ç­–ç•¥

```typescript
// Redisç¼“å­˜æœåŠ¡
class CacheService {
  // 1. ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆTTL: 1å°æ—¶ï¼‰
  async getUserById(userId: string): Promise<User> {
    const cacheKey = `user:${userId}`;

    // å°è¯•ä»ç¼“å­˜è·å–
    const cached = await redis.get(cacheKey);
    if (cached) {
      return JSON.parse(cached);
    }

    // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“æŸ¥è¯¢
    const user = await prisma.user.findUnique({ where: { id: userId } });

    // å†™å…¥ç¼“å­˜
    await redis.setex(cacheKey, 3600, JSON.stringify(user));

    return user;
  }

  // 2. æ‰“å¡æ•°æ®ç¼“å­˜ï¼ˆæŒ‰å¤©ï¼‰
  async getCachedCheckIns(userId: string, date: string): Promise<CheckIn[]> {
    const cacheKey = `check_ins:${userId}:${date}`;
    const cached = await redis.get(cacheKey);

    if (cached) {
      return JSON.parse(cached);
    }

    const checkIns = await prisma.checkIn.findMany({
      where: { userId, checkInDate: new Date(date) }
    });

    // ç¼“å­˜åˆ°å½“å¤©ç»“æŸ
    const ttl = this.getSecondsUntilEndOfDay();
    await redis.setex(cacheKey, ttl, JSON.stringify(checkIns));

    return checkIns;
  }

  // 3. æ’è¡Œæ¦œç¼“å­˜ï¼ˆä½¿ç”¨Sorted Setï¼‰
  async updateLeaderboard(userId: string, points: number): Promise<void> {
    await redis.zadd('leaderboard:points', points, userId);
  }

  async getLeaderboard(limit = 100): Promise<LeaderboardEntry[]> {
    const results = await redis.zrevrange(
      'leaderboard:points',
      0,
      limit - 1,
      'WITHSCORES'
    );

    // æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯
    const userIds = results.filter((_, i) => i % 2 === 0);
    const users = await this.batchGetUsers(userIds);

    return results
      .filter((_, i) => i % 2 === 1)
      .map((points, index) => ({
        rank: index + 1,
        user: users[index],
        points: parseInt(points)
      }));
  }

  // 4. AIå¯¹è¯ä¸Šä¸‹æ–‡ç¼“å­˜
  async cacheConversationContext(
    conversationId: string,
    context: any,
    ttl = 1800 // 30åˆ†é’Ÿ
  ): Promise<void> {
    const key = `ai:context:${conversationId}`;
    await redis.setex(key, ttl, JSON.stringify(context));
  }
}
```

### 8.3 å¼‚æ­¥å¤„ç†

```typescript
// ä½¿ç”¨Bullé˜Ÿåˆ—å¤„ç†è€—æ—¶ä»»åŠ¡
@Processor('health-analysis')
export class HealthAnalysisProcessor {
  @Process('risk-prediction')
  async handleRiskPrediction(job: Job) {
    const { userId } = job.data;

    try {
      // 1. è·å–æ‚£è€…å†å²æ•°æ®
      const healthData = await healthService.getHistoricalData(userId, 90);

      // 2. è°ƒç”¨AIæ¨¡å‹é¢„æµ‹
      const prediction = await aiService.predictRisk(healthData);

      // 3. ä¿å­˜é¢„æµ‹ç»“æœ
      await riskAssessmentRepository.create({
        userId,
        type: 'ai_prediction',
        riskLevel: prediction.level,
        riskScore: prediction.score,
        resultDetails: prediction.details
      });

      // 4. å¦‚æœé«˜é£é™©ï¼Œå‘é€é€šçŸ¥
      if (prediction.level === 'high') {
        await notificationQueue.add('send-alert', {
          userId,
          type: 'high_risk_warning',
          message: prediction.warning
        });
      }

      return { success: true };
    } catch (error) {
      logger.error('Risk prediction failed', error);
      throw error; // ä»»åŠ¡å¤±è´¥ä¼šè‡ªåŠ¨é‡è¯•
    }
  }
}

// å®šæ—¶ä»»åŠ¡ - æ¯æ—¥é£é™©åˆ†æ
@Injectable()
export class HealthScheduler {
  @Cron('0 2 * * *') // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
  async dailyRiskAnalysis() {
    const activeUsers = await userRepository.findActivePatients();

    // æ‰¹é‡æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—
    const jobs = activeUsers.map(user => ({
      name: 'risk-prediction',
      data: { userId: user.id }
    }));

    await healthAnalysisQueue.addBulk(jobs);

    logger.info(`Queued ${jobs.length} risk analysis tasks`);
  }
}
```

### 8.4 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

```typescript
// 1. React Queryæ•°æ®é¢„å–
function PatientListPage() {
  const queryClient = useQueryClient();

  const { data: patients } = useQuery({
    queryKey: ['patients'],
    queryFn: fetchPatients,
    staleTime: 5 * 60 * 1000 // 5åˆ†é’Ÿå†…ä¸é‡æ–°è¯·æ±‚
  });

  // é¼ æ ‡æ‚¬åœæ—¶é¢„å–è¯¦æƒ…
  const handlePatientHover = (patientId: string) => {
    queryClient.prefetchQuery({
      queryKey: ['patient', patientId],
      queryFn: () => fetchPatientDetails(patientId)
    });
  };

  return (
    <div>
      {patients?.map(patient => (
        <PatientCard
          key={patient.id}
          patient={patient}
          onMouseEnter={() => handlePatientHover(patient.id)}
        />
      ))}
    </div>
  );
}

// 2. è™šæ‹Ÿæ»šåŠ¨ - å¤„ç†å¤§åˆ—è¡¨
import { FixedSizeList } from 'react-window';

function CheckInHistoryList({ checkIns }: { checkIns: CheckIn[] }) {
  const Row = ({ index, style }: { index: number; style: React.CSSProperties }) => (
    <div style={style}>
      <CheckInItem data={checkIns[index]} />
    </div>
  );

  return (
    <FixedSizeList
      height={600}
      itemCount={checkIns.length}
      itemSize={80}
      width="100%"
    >
      {Row}
    </FixedSizeList>
  );
}

// 3. ä»£ç åˆ†å‰²
const DashboardPage = lazy(() => import('./pages/Dashboard'));
const HealthRecordsPage = lazy(() => import('./pages/HealthRecords'));

function App() {
  return (
    <Suspense fallback={<LoadingSpinner />}>
      <Routes>
        <Route path="/dashboard" element={<DashboardPage />} />
        <Route path="/health" element={<HealthRecordsPage />} />
      </Routes>
    </Suspense>
  );
}

// 4. å›¾ç‰‡ä¼˜åŒ–
function PatientAvatar({ url }: { url: string }) {
  return (
    <img
      src={url}
      alt="Avatar"
      loading="lazy"
      srcSet={`
        ${url}?w=100 100w,
        ${url}?w=200 200w,
        ${url}?w=400 400w
      `}
      sizes="(max-width: 600px) 100px, 200px"
    />
  );
}
```

---

## 9. éƒ¨ç½²æ¶æ„

### 9.1 Dockerå®¹å™¨åŒ–

```dockerfile
# backend/Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY package*.json ./
COPY pnpm-lock.yaml ./
RUN npm install -g pnpm && pnpm install --frozen-lockfile

# ç¼–è¯‘TypeScript
COPY . .
RUN pnpm build

# ç”Ÿäº§é•œåƒ
FROM node:18-alpine

WORKDIR /app

# åªå®‰è£…ç”Ÿäº§ä¾èµ–
COPY package*.json ./
COPY pnpm-lock.yaml ./
RUN npm install -g pnpm && pnpm install --prod --frozen-lockfile

# å¤åˆ¶ç¼–è¯‘äº§ç‰©
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/prisma ./prisma

# è¿è¡Œæ•°æ®åº“è¿ç§»å’Œå¯åŠ¨
CMD ["sh", "-c", "pnpm prisma migrate deploy && node dist/main.js"]

EXPOSE 3000
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: health_mgmt
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"

  # MongoDB
  mongodb:
    image: mongo:6
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    volumes:
      - mongo_data:/data/db
    ports:
      - "27017:27017"

  # ç”¨æˆ·æœåŠ¡
  user-service:
    build:
      context: ./services/user
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://admin:${DB_PASSWORD}@postgres:5432/health_mgmt
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "3001:3000"

  # å¥åº·æœåŠ¡
  health-service:
    build:
      context: ./services/health
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://admin:${DB_PASSWORD}@postgres:5432/health_mgmt
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
    depends_on:
      - postgres
      - redis
    ports:
      - "3002:3000"

  # AIæœåŠ¡
  ai-service:
    build:
      context: ./services/ai
      dockerfile: Dockerfile
    environment:
      MONGODB_URL: mongodb://admin:${MONGO_PASSWORD}@mongodb:27017
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      QDRANT_URL: http://qdrant:6333
    depends_on:
      - mongodb
      - qdrant
    ports:
      - "3003:3000"

  # å‘é‡æ•°æ®åº“
  qdrant:
    image: qdrant/qdrant:latest
    volumes:
      - qdrant_data:/qdrant/storage
    ports:
      - "6333:6333"

  # Nginxç½‘å…³
  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - user-service
      - health-service
      - ai-service

  # å‰ç«¯åº”ç”¨
  web-app:
    build:
      context: ./frontend/web
      dockerfile: Dockerfile
    ports:
      - "3000:80"

volumes:
  postgres_data:
  redis_data:
  mongo_data:
  qdrant_data:
```

### 9.2 Kuberneteséƒ¨ç½²

```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: health-service
  labels:
    app: health-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: health-service
  template:
    metadata:
      labels:
        app: health-service
    spec:
      containers:
      - name: health-service
        image: health-mgmt/health-service:latest
        ports:
        - containerPort: 3000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: redis-credentials
              key: url
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: health-service
spec:
  selector:
    app: health-service
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3000
  type: ClusterIP

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: health-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: health-service
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

### 9.3 CI/CDæµç¨‹

```yaml
# .github/workflows/deploy.yml
name: Build and Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test

      - name: Run E2E tests
        run: pnpm test:e2e

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push images
        run: |
          docker build -t health-mgmt/user-service:${{ github.sha }} ./services/user
          docker push health-mgmt/user-service:${{ github.sha }}

          docker build -t health-mgmt/health-service:${{ github.sha }} ./services/health
          docker push health-mgmt/health-service:${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Kubernetes
        uses: azure/k8s-deploy@v4
        with:
          manifests: |
            k8s/deployment.yaml
            k8s/service.yaml
          images: |
            health-mgmt/user-service:${{ github.sha }}
            health-mgmt/health-service:${{ github.sha }}
          kubectl-version: 'latest'
```

---

## 10. ç›‘æ§ä¸è¿ç»´

### 10.1 æ—¥å¿—æ”¶é›†

```typescript
// Winstonæ—¥å¿—é…ç½®
import winston from 'winston';
import 'winston-daily-rotate-file';

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: {
    service: 'health-service',
    environment: process.env.NODE_ENV
  },
  transports: [
    // æ§åˆ¶å°è¾“å‡º
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    }),

    // æŒ‰æ—¥æœŸè½®è½¬çš„æ–‡ä»¶æ—¥å¿—
    new winston.transports.DailyRotateFile({
      filename: 'logs/application-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      maxSize: '100m',
      maxFiles: '30d'
    }),

    // é”™è¯¯æ—¥å¿—å•ç‹¬å­˜å‚¨
    new winston.transports.DailyRotateFile({
      filename: 'logs/error-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      level: 'error',
      maxFiles: '90d'
    })
  ]
});

// ç»“æ„åŒ–æ—¥å¿—ç¤ºä¾‹
logger.info('User check-in created', {
  userId: 'user-123',
  checkInType: 'blood_pressure',
  value: { systolic: 120, diastolic: 80 },
  pointsEarned: 10
});
```

### 10.2 æ€§èƒ½ç›‘æ§

```typescript
// PrometheusæŒ‡æ ‡å¯¼å‡º
import { Registry, Counter, Histogram } from 'prom-client';

const register = new Registry();

// HTTPè¯·æ±‚è®¡æ•°å™¨
const httpRequestsTotal = new Counter({
  name: 'http_requests_total',
  help: 'Total HTTP requests',
  labelNames: ['method', 'route', 'status'],
  registers: [register]
});

// è¯·æ±‚å»¶è¿Ÿç›´æ–¹å›¾
const httpRequestDuration = new Histogram({
  name: 'http_request_duration_seconds',
  help: 'HTTP request duration in seconds',
  labelNames: ['method', 'route', 'status'],
  buckets: [0.1, 0.5, 1, 2, 5],
  registers: [register]
});

// AIè°ƒç”¨è®¡æ•°å™¨
const aiCallsTotal = new Counter({
  name: 'ai_calls_total',
  help: 'Total AI API calls',
  labelNames: ['provider', 'model', 'status'],
  registers: [register]
});

// ä¸­é—´ä»¶æ”¶é›†æŒ‡æ ‡
app.use((req, res, next) => {
  const start = Date.now();

  res.on('finish', () => {
    const duration = (Date.now() - start) / 1000;
    const route = req.route?.path || req.path;

    httpRequestsTotal.inc({
      method: req.method,
      route,
      status: res.statusCode
    });

    httpRequestDuration.observe(
      { method: req.method, route, status: res.statusCode },
      duration
    );
  });

  next();
});

// æš´éœ²metricsç«¯ç‚¹
app.get('/metrics', async (req, res) => {
  res.set('Content-Type', register.contentType);
  res.end(await register.metrics());
});
```

---

## 12. æ¶æ„æ¼”è¿›è¿ç§»æŒ‡å—

### 12.1 è¿ç§»å†³ç­–åˆ¤æ–­

**ä½•æ—¶ä»MVPå‡çº§åˆ°ä¼ä¸šçº§ï¼Ÿ**

æ»¡è¶³ä»¥ä¸‹**ä»»ä¸€æ¡ä»¶**æ—¶ï¼Œå»ºè®®å¯åŠ¨æ¶æ„å‡çº§ï¼š

| è§¦å‘æ¡ä»¶ | é˜ˆå€¼ | è¯´æ˜ |
|---------|------|------|
| **ç”¨æˆ·è§„æ¨¡** | æ³¨å†Œç”¨æˆ· > 5ä¸‡ | å•ä½“æ¶æ„æ€§èƒ½ç“¶é¢ˆ |
| **å¹¶å‘å‹åŠ›** | åŒæ—¶åœ¨çº¿ > 5000äºº | éœ€è¦è´Ÿè½½å‡è¡¡å’Œé›†ç¾¤ |
| **æ•°æ®é‡** | å¥åº·æ•°æ® > 500ä¸‡æ¡ | éœ€è¦åˆ†åº“åˆ†è¡¨ |
| **ä¼ä¸šå®¢æˆ·** | ç­¾çº¦å¤§å‹åŒ»é™¢/æœºæ„ | éœ€è¦é«˜å¯ç”¨æ€§ä¿è¯ |
| **åˆè§„è¦æ±‚** | ç­‰ä¿ä¸‰çº§è®¤è¯éœ€æ±‚ | å¿…é¡»ç¬¦åˆåŒ»ç–—è¡Œä¸šæ ‡å‡† |
| **è®¾å¤‡æ¥å…¥** | IoTè®¾å¤‡ > 1ä¸‡å° | MQTTéœ€è¦é›†ç¾¤åŒ– |
| **è¥æ”¶** | æœˆè¥æ”¶ > 50ä¸‡ | æœ‰é¢„ç®—æ”¯æ’‘å‡çº§æˆæœ¬ |

**å†³ç­–æµç¨‹**ï¼š
```
è¯„ä¼°å½“å‰æƒ…å†µ
    â”‚
    â”œâ”€ è¾¾åˆ°è§¦å‘æ¡ä»¶ï¼Ÿ
    â”‚       â”‚
    â”‚       â”œâ”€ æ˜¯ â†’ å‡†å¤‡è¿ç§»è®¡åˆ’
    â”‚       â”‚       â”œâ”€ é¢„ç®—è¯„ä¼°
    â”‚       â”‚       â”œâ”€ å›¢é˜Ÿæ‰©å……
    â”‚       â”‚       â””â”€ åˆ¶å®šæ—¶é—´è¡¨
    â”‚       â”‚
    â”‚       â””â”€ å¦ â†’ ç»§ç»­ä¼˜åŒ–MVP
    â”‚               â”œâ”€ æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
    â”‚               â”œâ”€ ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
    â”‚               â””â”€ å‚ç›´æ‰©å®¹ï¼ˆå‡çº§æœåŠ¡å™¨ï¼‰
```

---

### 12.2 åˆ†é˜¶æ®µè¿ç§»è·¯çº¿å›¾

**æ€»æ—¶é•¿ï¼š6-8ä¸ªæœˆ**ï¼ˆå»ºè®®åœ¨ä¸šåŠ¡ä½è°·æœŸè¿›è¡Œï¼‰

#### é˜¶æ®µ0ï¼šå‡†å¤‡æœŸï¼ˆ1ä¸ªæœˆï¼‰

**ç›®æ ‡**ï¼šåˆ¶å®šè¯¦ç»†è¿ç§»è®¡åˆ’ï¼Œé™ä½é£é™©

**å…³é”®ä»»åŠ¡**ï¼š
- [ ] ä»£ç å®¡è®¡ï¼šè¯„ä¼°MVPä»£ç è´¨é‡ï¼Œæ ‡è®°éœ€è¦é‡æ„çš„æ¨¡å—
- [ ] æ•°æ®ç›˜ç‚¹ï¼šç»Ÿè®¡æ•°æ®é‡ã€å¢é•¿é€Ÿåº¦ã€çƒ­ç‚¹æ•°æ®
- [ ] æ¥å£æ¢³ç†ï¼šæ•´ç†æ‰€æœ‰APIæ¥å£æ–‡æ¡£ï¼ˆOpenAPIè§„èŒƒï¼‰
- [ ] å›¢é˜ŸåŸ¹è®­ï¼šJava/Spring CloudæŠ€æœ¯æ ˆåŸ¹è®­
- [ ] é¢„ç®—å®¡æ‰¹ï¼šè·å–ç®¡ç†å±‚æ‰¹å‡†
- [ ] ç¯å¢ƒå‡†å¤‡ï¼šé‡‡è´­æœåŠ¡å™¨ã€å¼€é€šK8sé›†ç¾¤

**äº§å‡ºç‰©**ï¼š
- è¿ç§»é¡¹ç›®è®¡åˆ’ä¹¦
- æ¥å£æ–‡æ¡£ï¼ˆSwagger/OpenAPIï¼‰
- æ•°æ®è¿ç§»æ–¹æ¡ˆ
- é£é™©è¯„ä¼°æŠ¥å‘Š

---

#### é˜¶æ®µ1ï¼šåŸºç¡€è®¾æ–½æ­å»ºï¼ˆ1-2ä¸ªæœˆï¼‰

**ç›®æ ‡**ï¼šæ­å»ºä¼ä¸šçº§åŸºç¡€è®¾æ–½ï¼Œä¸MVPç¯å¢ƒå¹¶è¡Œè¿è¡Œ

**å…³é”®ä»»åŠ¡**ï¼š

**1.1 K8sé›†ç¾¤æ­å»º**
```bash
# ä½¿ç”¨é˜¿é‡Œäº‘ACKæ‰˜ç®¡é›†ç¾¤
aliyun cs CreateManagedKubernetesCluster \
  --name health-mgmt-prod \
  --kubernetes-version 1.28 \
  --num-of-nodes 3 \
  --worker-instance-types ecs.c6.xlarge
```

**1.2 æ•°æ®åº“è¿ç§»**
```sql
-- PostgreSQL â†’ MySQL æ•°æ®è¿ç§»
-- ä½¿ç”¨å·¥å…·ï¼špgloader
pgloader postgresql://user:pass@old-host/health_mgmt \
          mysql://user:pass@new-host/health_mgmt

-- æ•°æ®éªŒè¯
SELECT COUNT(*) FROM users;  -- å¯¹æ¯”æ•°é‡
SELECT MD5(GROUP_CONCAT(id ORDER BY id)) FROM users;  -- å¯¹æ¯”æ•°æ®å®Œæ•´æ€§
```

**1.3 ä¸­é—´ä»¶éƒ¨ç½²**
- Nacosï¼ˆæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼‰
- RocketMQï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
- Redis Clusterï¼ˆç¼“å­˜é›†ç¾¤ï¼‰
- EMQXä¼ä¸šç‰ˆï¼ˆMQTT Brokerï¼‰

**äº§å‡ºç‰©**ï¼š
- K8sé›†ç¾¤è¿è¡Œæ­£å¸¸
- æ•°æ®åº“è¿ç§»å®Œæˆå¹¶éªŒè¯
- ä¸­é—´ä»¶å…¨éƒ¨å°±ç»ª

---

#### é˜¶æ®µ2ï¼šAIæœåŠ¡è¿ç§»ï¼ˆ1ä¸ªæœˆï¼‰

**ç›®æ ‡**ï¼šä¼˜å…ˆè¿ç§»AIæœåŠ¡ï¼ˆPythonä»£ç ç›´æ¥å¤ç”¨ï¼‰

**ä¸ºä»€ä¹ˆå…ˆè¿ç§»AIï¼Ÿ**
- âœ… Pythonä»£ç 100%å¤ç”¨ï¼Œæ— éœ€é‡å†™
- âœ… ç‹¬ç«‹æœåŠ¡ï¼Œä¸å½±å“ä¸»ä¸šåŠ¡
- âœ… éªŒè¯K8séƒ¨ç½²æµç¨‹

**è¿ç§»æ­¥éª¤**ï¼š

**2.1 å®¹å™¨åŒ–AIæœåŠ¡**
```dockerfile
# ai-service/Dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶ä»£ç ï¼ˆä»MVPç›´æ¥å¤ç”¨ï¼‰
COPY . .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**2.2 éƒ¨ç½²åˆ°K8s**
```yaml
# k8s/ai-service.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-service
spec:
  replicas: 2  # 2ä¸ªPodå®ä¾‹
  selector:
    matchLabels:
      app: ai-service
  template:
    metadata:
      labels:
        app: ai-service
    spec:
      containers:
      - name: ai-service
        image: registry.cn-hangzhou.aliyuncs.com/health-mgmt/ai-service:1.0.0
        ports:
        - containerPort: 8000
        env:
        - name: DEEPSEEK_API_KEY
          valueFrom:
            secretKeyRef:
              name: ai-secrets
              key: api-key
```

**2.3 åŒç¯å¢ƒå¹¶è¡Œè¿è¡Œ**
```
æ—§ç¯å¢ƒï¼ˆMVPï¼‰ï¼š  http://mvp.vakyi.com
æ–°ç¯å¢ƒï¼ˆä¼ä¸šç‰ˆï¼‰ï¼šhttp://ent.vakyi.com

ç°åº¦ç­–ç•¥ï¼š10% â†’ 30% â†’ 50% â†’ 100%
```

**éªŒè¯æŒ‡æ ‡**ï¼š
- âœ… æ¥å£å“åº”æ—¶é—´ < 500ms
- âœ… é”™è¯¯ç‡ < 0.1%
- âœ… AIå›ç­”è´¨é‡ï¼ˆäººå·¥æŠ½æ ·å¯¹æ¯”ï¼‰

**äº§å‡ºç‰©**ï¼š
- AIæœåŠ¡æˆåŠŸè¿ç§»åˆ°K8s
- æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡
- å‘é‡æ•°æ®åº“æ•°æ®è¿ç§»å®Œæˆ

---

#### é˜¶æ®µ3ï¼šJavaå¾®æœåŠ¡å¼€å‘ï¼ˆ2-3ä¸ªæœˆï¼‰

**ç›®æ ‡**ï¼šç”¨Javaé‡å†™æ ¸å¿ƒä¸šåŠ¡æœåŠ¡

**3.1 æœåŠ¡æ‹†åˆ†ä¼˜å…ˆçº§**

**ç¬¬ä¸€æ‰¹ï¼ˆæ ¸å¿ƒæœåŠ¡ï¼‰**ï¼š
1. **ç”¨æˆ·æœåŠ¡** - è®¤è¯æˆæƒæœ€å…³é”®
2. **å¥åº·æœåŠ¡** - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

**ç¬¬äºŒæ‰¹ï¼ˆæ”¯æ’‘æœåŠ¡ï¼‰**ï¼š
3. **ç§¯åˆ†æœåŠ¡** - ç›¸å¯¹ç‹¬ç«‹
4. **é€šçŸ¥æœåŠ¡** - ç›¸å¯¹ç‹¬ç«‹

**ç¬¬ä¸‰æ‰¹ï¼ˆå¤æ‚æœåŠ¡ï¼‰**ï¼š
5. **é€šè®¯æœåŠ¡** - WebSocketéœ€è¦ç‰¹æ®Šå¤„ç†

**3.2 æ¥å£å…¼å®¹æ€§ä¿è¯**

```java
// ä¿æŒä¸NestJSç›¸åŒçš„æ¥å£å®šä¹‰
@RestController
@RequestMapping("/api/health")
public class HealthController {

    @PostMapping("/check-ins")
    public ResponseEntity<ApiResponse> createCheckIn(
        @RequestBody CheckInRequest request
    ) {
        // ç¡®ä¿è¯·æ±‚/å“åº”æ ¼å¼ä¸MVPå®Œå…¨ä¸€è‡´
        // å‰ç«¯ä»£ç æ— éœ€ä¿®æ”¹
    }
}

// ç»Ÿä¸€å“åº”æ ¼å¼
public class ApiResponse<T> {
    private boolean success;
    private T data;
    private ErrorInfo error;
}
```

**3.3 æ•°æ®è®¿é—®å±‚è¿ç§»**

```java
// ä½¿ç”¨MyBatis Plusï¼Œç®€åŒ–å¼€å‘
@Mapper
public interface CheckInMapper extends BaseMapper<CheckIn> {
    // è‡ªåŠ¨ç”ŸæˆCRUDæ–¹æ³•
    // å¤æ‚æŸ¥è¯¢æ‰‹å†™SQL
    @Select("SELECT * FROM check_ins WHERE user_id = #{userId} AND check_in_date = #{date}")
    List<CheckIn> findByUserAndDate(String userId, LocalDate date);
}
```

**äº§å‡ºç‰©**ï¼š
- 5ä¸ªJavaå¾®æœåŠ¡å…¨éƒ¨å¼€å‘å®Œæˆ
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- é›†æˆæµ‹è¯•é€šè¿‡

---

#### é˜¶æ®µ4ï¼šç°åº¦å‘å¸ƒä¸åˆ‡æ¢ï¼ˆ1-2ä¸ªæœˆï¼‰

**ç›®æ ‡**ï¼šå¹³æ»‘åˆ‡æ¢ç”¨æˆ·æµé‡ï¼Œé›¶åœæœºè¿ç§»

**4.1 ç°åº¦å‘å¸ƒç­–ç•¥**

```
ç¬¬1å‘¨ï¼šå†…éƒ¨æµ‹è¯•è´¦å·ï¼ˆ1%æµé‡ï¼‰
    â†“ éªŒè¯é€šè¿‡
ç¬¬2å‘¨ï¼šå°éƒ¨åˆ†çœŸå®ç”¨æˆ·ï¼ˆ10%æµé‡ï¼‰
    â†“ è§‚å¯ŸæŒ‡æ ‡
ç¬¬3å‘¨ï¼šæ‰©å¤§èŒƒå›´ï¼ˆ30%æµé‡ï¼‰
    â†“
ç¬¬4å‘¨ï¼šè¿‡åŠç”¨æˆ·ï¼ˆ50%æµé‡ï¼‰
    â†“
ç¬¬6å‘¨ï¼šç»å¤§éƒ¨åˆ†ç”¨æˆ·ï¼ˆ80%æµé‡ï¼‰
    â†“
ç¬¬8å‘¨ï¼šå…¨é‡åˆ‡æ¢ï¼ˆ100%æµé‡ï¼‰
```

**4.2 æµé‡åˆ‡æ¢å®ç°**

**æ–¹æ¡ˆAï¼šNginxæƒé‡åˆ†æµ**
```nginx
upstream backend {
    server old-server:3000 weight=20;  # æ—§ç¯å¢ƒ 20%
    server new-server:8080 weight=80;  # æ–°ç¯å¢ƒ 80%
}
```

**æ–¹æ¡ˆBï¼šåŸºäºHeaderç°åº¦**
```nginx
# ç‰¹å®šç”¨æˆ·èµ°æ–°ç¯å¢ƒ
if ($http_x_user_group = "beta") {
    proxy_pass http://new-server;
}
# å…¶ä»–ç”¨æˆ·èµ°æ—§ç¯å¢ƒ
proxy_pass http://old-server;
```

**4.3 æ•°æ®åŒæ­¥ç­–ç•¥**

è¿ç§»æœŸé—´ï¼Œæ–°æ—§ç¯å¢ƒæ•°æ®**åŒå†™**ï¼š

```java
@Service
public class CheckInService {

    @Transactional
    public void createCheckIn(CheckInRequest request) {
        // 1. å†™å…¥æ–°æ•°æ®åº“ï¼ˆMySQLï¼‰
        checkInMapper.insert(checkIn);

        // 2. å¼‚æ­¥åŒæ­¥åˆ°æ—§æ•°æ®åº“ï¼ˆPostgreSQLï¼‰
        // é˜²æ­¢æ•°æ®ä¸ä¸€è‡´
        messageQueue.send("sync-to-old-db", checkIn);
    }
}
```

**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | é˜ˆå€¼ | å¼‚å¸¸å¤„ç† |
|------|------|---------|
| æ¥å£å“åº”æ—¶é—´ | P99 < 1s | è‡ªåŠ¨å›æ»šåˆ°æ—§ç¯å¢ƒ |
| é”™è¯¯ç‡ | < 0.5% | æŠ¥è­¦å¹¶åˆ†æ |
| æ•°æ®ä¸€è‡´æ€§ | 100% | åœæ­¢ç°åº¦ï¼Œä¿®å¤é—®é¢˜ |
| ç”¨æˆ·æŠ•è¯‰ | 0ä¸¥é‡æŠ•è¯‰ | ç«‹å³å›æ»š |

**äº§å‡ºç‰©**ï¼š
- æµé‡100%åˆ‡æ¢åˆ°æ–°ç¯å¢ƒ
- æ—§ç¯å¢ƒä¿ç•™7å¤©ä½œä¸ºå¤‡ä»½
- ç”¨æˆ·æ— æ„ŸçŸ¥è¿ç§»

---

#### é˜¶æ®µ5ï¼šæ—§ç¯å¢ƒä¸‹çº¿ï¼ˆ1ä¸ªæœˆï¼‰

**ç›®æ ‡**ï¼šæ¸…ç†æ—§ç¯å¢ƒï¼Œé™ä½æˆæœ¬

**5.1 ä¸‹çº¿æ£€æŸ¥æ¸…å•**

- [ ] æ‰€æœ‰æµé‡å·²åˆ‡æ¢åˆ°æ–°ç¯å¢ƒ
- [ ] æ–°ç¯å¢ƒè¿è¡Œç¨³å®š30å¤©ä»¥ä¸Š
- [ ] æ•°æ®è¿ç§»100%å®Œæˆå¹¶éªŒè¯
- [ ] å¤‡ä»½æ—§ç¯å¢ƒæ•°æ®
- [ ] é€šçŸ¥æ‰€æœ‰ç›¸å…³äººå‘˜

**5.2 æ•°æ®å¤‡ä»½**

```bash
# å¤‡ä»½PostgreSQLæ•°æ®
pg_dump -h old-server -U admin health_mgmt > backup_$(date +%Y%m%d).sql

# å½’æ¡£åˆ°å¯¹è±¡å­˜å‚¨
ossutil cp backup_*.sql oss://health-mgmt-backup/postgres/

# ä¿ç•™1å¹´ï¼Œç„¶ååˆ é™¤
```

**5.3 èµ„æºé‡Šæ”¾**

```bash
# åœæ­¢æ—§æœåŠ¡
docker-compose down

# é‡Šæ”¾æœåŠ¡å™¨
aliyun ecs StopInstance --instance-id i-xxxxxx

# å–æ¶ˆç»­è´¹
```

**æˆæœ¬èŠ‚çœ**ï¼š
- é‡Šæ”¾æ—§ECSï¼šèŠ‚çœÂ¥200/æœˆ
- ä¿ç•™K8sé›†ç¾¤ï¼šæ–°å¢Â¥7500/æœˆ
- **å‡€å¢æˆæœ¬**ï¼šçº¦Â¥7300/æœˆ

---

### 12.3 é£é™©æ§åˆ¶ä¸åº”æ€¥é¢„æ¡ˆ

#### é£é™©è¯†åˆ«

| é£é™©ç­‰çº§ | é£é™©ç‚¹ | æ¦‚ç‡ | å½±å“ | åº”å¯¹ç­–ç•¥ |
|---------|-------|------|------|----------|
| ğŸ”´ é«˜ | æ•°æ®è¿ç§»ä¸¢å¤± | ä¸­ | æé«˜ | å¤šæ¬¡éªŒè¯+å¤‡ä»½ |
| ğŸ”´ é«˜ | æœåŠ¡ä¸­æ–­è¶…è¿‡1å°æ—¶ | ä½ | é«˜ | ç°åº¦å‘å¸ƒ+å¿«é€Ÿå›æ»š |
| ğŸŸ¡ ä¸­ | æ€§èƒ½ä¸‹é™ | ä¸­ | ä¸­ | å‹æµ‹+æ€§èƒ½è°ƒä¼˜ |
| ğŸŸ¡ ä¸­ | æ¥å£ä¸å…¼å®¹ | ä¸­ | ä¸­ | è‡ªåŠ¨åŒ–æµ‹è¯• |
| ğŸŸ¢ ä½ | æˆæœ¬è¶…æ”¯ | ä½ | ä½ | é¢„ç®—é¢„ç•™20% |

#### åº”æ€¥å›æ»šæ–¹æ¡ˆ

**å›æ»šè§¦å‘æ¡ä»¶**ï¼ˆæ»¡è¶³ä»»ä¸€æ¡å³å›æ»šï¼‰ï¼š
- é”™è¯¯ç‡ > 1%
- æ¥å£å“åº”æ—¶é—´ > 3ç§’
- å‡ºç°æ•°æ®ä¸¢å¤±
- ä¸¥é‡ç”¨æˆ·æŠ•è¯‰

**å›æ»šæ“ä½œ**ï¼ˆ15åˆ†é’Ÿå†…å®Œæˆï¼‰ï¼š
```bash
# 1. åˆ‡æ¢DNSæˆ–Nginxé…ç½®æŒ‡å‘æ—§ç¯å¢ƒ
nginx -s reload

# 2. åœæ­¢æ–°ç¯å¢ƒæœåŠ¡ï¼ˆé˜²æ­¢æ•°æ®å†™å…¥ï¼‰
kubectl scale deployment --replicas=0 --all

# 3. é€šçŸ¥å›¢é˜Ÿ
é’‰é’‰/ä¼ä¸šå¾®ä¿¡å‘é€å›æ»šé€šçŸ¥

# 4. é—®é¢˜åˆ†æ
æ”¶é›†æ—¥å¿—ã€æ•°æ®åº“çŠ¶æ€ã€ç›‘æ§æŒ‡æ ‡
```

#### æ•°æ®ä¸€è‡´æ€§ä¿éšœ

**åŒå†™æœŸé—´æ•°æ®å¯¹è´¦**ï¼š

```python
# æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡å¯¹è´¦è„šæœ¬
def data_reconciliation():
    # å¯¹æ¯”æ–°æ—§æ•°æ®åº“
    old_count = pg_client.execute("SELECT COUNT(*) FROM check_ins WHERE created_at > NOW() - INTERVAL '1 hour'")
    new_count = mysql_client.execute("SELECT COUNT(*) FROM check_ins WHERE created_at > NOW() - INTERVAL 1 HOUR")

    if old_count != new_count:
        alert("æ•°æ®ä¸ä¸€è‡´ï¼æ—§åº“: {old_count}, æ–°åº“: {new_count}")
        # è¡¥å¿æœºåˆ¶ï¼šé‡æ–°åŒæ­¥å·®å¼‚æ•°æ®
```

---

### 12.4 è¿ç§»æˆæœ¬ä¼°ç®—

#### ä¸€æ¬¡æ€§æˆæœ¬

| é¡¹ç›® | é‡‘é¢ | è¯´æ˜ |
|------|------|------|
| æœåŠ¡å™¨é‡‡è´­/ç§Ÿèµ | Â¥20,000 | 10å°ECSé¦–æ¬¡ä»˜è´¹ï¼ˆå¹´ä»˜ä¼˜æƒ ï¼‰ |
| K8sé›†ç¾¤æ­å»º | Â¥5,000 | æŠ€æœ¯æœåŠ¡è´¹ |
| æ•°æ®è¿ç§»å·¥å…· | Â¥3,000 | ä¸“ä¸šè¿ç§»å·¥å…·æˆæƒ |
| äººå‘˜åŸ¹è®­ | Â¥10,000 | Java/Spring CloudåŸ¹è®­ |
| ç¬¬ä¸‰æ–¹å’¨è¯¢ | Â¥15,000 | æ¶æ„å’¨è¯¢ã€ç­‰ä¿å’¨è¯¢ |
| **åˆè®¡** | **Â¥53,000** | |

#### æœˆåº¦æˆæœ¬å¯¹æ¯”

| é¡¹ç›® | MVPé˜¶æ®µ | ä¼ä¸šçº§é˜¶æ®µ | å¢é‡ |
|------|---------|------------|------|
| æœåŠ¡å™¨ | Â¥200 | Â¥2,000 | +Â¥1,800 |
| æ•°æ®åº“ | Â¥0 | Â¥1,500 | +Â¥1,500 |
| ç¼“å­˜ | Â¥0 | Â¥800 | +Â¥800 |
| å¯¹è±¡å­˜å‚¨ | Â¥50 | Â¥300 | +Â¥250 |
| K8sæ‰˜ç®¡ | Â¥0 | Â¥500 | +Â¥500 |
| AIè°ƒç”¨ | Â¥500 | Â¥2,000 | +Â¥1,500 |
| ç›‘æ§æ—¥å¿— | Â¥0 | Â¥500 | +Â¥500 |
| äººåŠ›æˆæœ¬ | Â¥50,000 | Â¥100,000 | +Â¥50,000 |
| **æœˆåº¦åˆè®¡** | **Â¥50,750** | **Â¥107,600** | **+Â¥56,850** |

**ROIåˆ†æ**ï¼š
- ä¼ä¸šçº§å®¢æˆ·å¹´è´¹ï¼šçº¦Â¥300,000/å®¶
- éœ€ç­¾çº¦2å®¶ä¼ä¸šçº§å®¢æˆ·å³å¯è¦†ç›–å‡çº§æˆæœ¬
- åç»­è¾¹é™…æˆæœ¬ä½ï¼Œè§„æ¨¡æ•ˆåº”æ˜æ˜¾

---

### 12.5 è¿ç§»æ£€æŸ¥æ¸…å•

#### è¿ç§»å‰æ£€æŸ¥

- [ ] ä»£ç å®¡è®¡å®Œæˆï¼Œæ— æ˜æ˜¾æŠ€æœ¯å€ºåŠ¡
- [ ] æ¥å£æ–‡æ¡£é½å…¨ï¼ˆOpenAPIè§„èŒƒï¼‰
- [ ] æ•°æ®å¤‡ä»½å®Œæˆï¼ˆè‡³å°‘3ä»½ï¼‰
- [ ] å›¢é˜ŸåŸ¹è®­å®Œæˆï¼ˆJava/Spring Cloudï¼‰
- [ ] é¢„ç®—å®¡æ‰¹é€šè¿‡
- [ ] æ—¶é—´è¡¨è·å¾—ç®¡ç†å±‚æ‰¹å‡†
- [ ] åº”æ€¥é¢„æ¡ˆåˆ¶å®šå®Œæˆ
- [ ] ç›‘æ§å‘Šè­¦ç³»ç»Ÿå°±ç»ª

#### è¿ç§»ä¸­æ£€æŸ¥

- [ ] æ¯æ—¥ç«™ä¼šåŒæ­¥è¿›åº¦
- [ ] æ¯å‘¨æ•°æ®å¯¹è´¦
- [ ] è‡ªåŠ¨åŒ–æµ‹è¯•é€šè¿‡ç‡ > 95%
- [ ] ç°åº¦å‘å¸ƒä¸¥æ ¼æŒ‰è®¡åˆ’æ‰§è¡Œ
- [ ] å…³é”®æŒ‡æ ‡å®æ—¶ç›‘æ§
- [ ] ç”¨æˆ·åé¦ˆæ¸ é“ç•…é€š

#### è¿ç§»åæ£€æŸ¥

- [ ] æ–°ç¯å¢ƒç¨³å®šè¿è¡Œ30å¤©
- [ ] æ—§ç¯å¢ƒæ•°æ®å·²å½’æ¡£
- [ ] æˆæœ¬åœ¨é¢„ç®—èŒƒå›´å†…
- [ ] ç”¨æˆ·æ»¡æ„åº¦æ— ä¸‹é™
- [ ] å›¢é˜ŸçŸ¥è¯†æ²‰æ·€å®Œæˆï¼ˆè¿ç§»æ–‡æ¡£ï¼‰
- [ ] å¤ç›˜ä¼šè®®å¬å¼€

---

## 13. æ€»ç»“

æœ¬è®¾è®¡æ–‡æ¡£è¯¦ç»†è§„åˆ’äº†æ™ºæ…§æ…¢ç—…ç®¡ç†ç³»ç»Ÿçš„æŠ€æœ¯æ¶æ„ï¼ŒåŒ…æ‹¬ï¼š

1. **å¾®æœåŠ¡æ¶æ„**ï¼šå°†ç³»ç»Ÿæ‹†åˆ†ä¸º7ä¸ªç‹¬ç«‹æœåŠ¡ï¼Œå®ç°é«˜å†…èšä½è€¦åˆ
2. **AIæ·±åº¦é›†æˆ**ï¼šé€šè¿‡é€‚é…å™¨æ¨¡å¼æ”¯æŒå¤šAIæä¾›å•†ï¼ŒRAGæ¶æ„æå‡ç§‘æ™®è´¨é‡
3. **æ•°æ®å®‰å…¨**ï¼šå¤šå±‚æ¬¡åŠ å¯†ã€RBACæƒé™ã€å®¡è®¡æ—¥å¿—ä¿éšœéšç§
4. **é«˜æ€§èƒ½**ï¼šç¼“å­˜ç­–ç•¥ã€å¼‚æ­¥å¤„ç†ã€æ•°æ®åº“ä¼˜åŒ–ç¡®ä¿ç³»ç»Ÿå“åº”é€Ÿåº¦
5. **å¯æ‰©å±•æ€§**ï¼šå®¹å™¨åŒ–éƒ¨ç½²ã€K8sç¼–æ’ã€æ°´å¹³æ‰©å±•æ”¯æŒä¸šåŠ¡å¢é•¿
6. **å…¨é¢æµ‹è¯•**ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€E2Eæµ‹è¯•ä¿éšœä»£ç è´¨é‡

è¯¥è®¾è®¡ä¸ºåç»­å¼€å‘æä¾›äº†æ¸…æ™°çš„æŠ€æœ¯è·¯çº¿å’Œæœ€ä½³å®è·µæŒ‡å¯¼ã€‚
