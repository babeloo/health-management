version: '3.8'

services:
  # PostgreSQL 主数据库
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      POSTGRES_DB: health_mgmt
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ${DB_PASSWORD:-admin123}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - '5432:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U admin -d health_mgmt']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - health-mgmt

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis123}
    volumes:
      - redis_data:/data
    ports:
      - '6379:6379'
    healthcheck:
      test: ['CMD', 'redis-cli', '-a', '${REDIS_PASSWORD:-redis123}', '--no-auth-warning', 'ping']
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - health-mgmt

  # InfluxDB 时序数据库
  influxdb:
    image: influxdb:2.7-alpine
    container_name: influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD:-influx123}
      DOCKER_INFLUXDB_INIT_ORG: vakyi
      DOCKER_INFLUXDB_INIT_BUCKET: health_data
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_TOKEN:-my-super-secret-auth-token}
    volumes:
      - influxdb_data:/var/lib/influxdb2
    ports:
      - '8086:8086'
    networks:
      - health-mgmt

  # Qdrant 向量数据库
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    volumes:
      - qdrant_data:/qdrant/storage
    ports:
      - '6333:6333'
      - '6334:6334'
    networks:
      - health-mgmt

  # MongoDB (消息存储)
  mongodb:
    image: mongo:6
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-mongo123}
      MONGO_INITDB_DATABASE: health_messages
    volumes:
      - mongo_data:/data/db
    ports:
      - '27017:27017'
    networks:
      - health-mgmt

  # EMQX MQTT Broker
  emqx:
    image: emqx/emqx:latest
    container_name: emqx
    environment:
      EMQX_NAME: emqx
      EMQX_HOST: ${EMQX_HOST:-emqx}
      EMQX_DASHBOARD__DEFAULT_USERNAME: admin
      EMQX_DASHBOARD__DEFAULT_PASSWORD: ${EMQX_PASSWORD:-emqx123}
      # PostgreSQL 连接信息 (用于设备认证和 ACL)
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: health_mgmt
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ${DB_PASSWORD:-admin123}
    volumes:
      - emqx_data:/opt/emqx/data
      - emqx_log:/opt/emqx/log
      # 挂载配置文件
      - ./emqx/emqx.conf:/opt/emqx/etc/emqx.conf:ro
      - ./emqx/auth-pgsql.conf:/opt/emqx/etc/auth-pgsql.conf:ro
      - ./emqx/acl.conf:/opt/emqx/etc/acl.conf:ro
    ports:
      - '1883:1883' # MQTT
      - '8883:8883' # MQTT/SSL
      - '8083:8083' # WebSocket
      - '18083:18083' # Dashboard
    depends_on:
      - postgres
    networks:
      - health-mgmt

  # MinIO 对象存储
  minio:
    image: minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_USER:-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD:-minio123}
    volumes:
      - minio_data:/data
    ports:
      - '9000:9000' # API
      - '9001:9001' # Console
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - health-mgmt

volumes:
  postgres_data:
  redis_data:
  influxdb_data:
  qdrant_data:
  mongo_data:
  emqx_data:
  emqx_log:
  minio_data:

networks:
  health-mgmt:
    driver: bridge
