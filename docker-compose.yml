version: '3.8'

services:
  # PostgreSQL 主数据库
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      POSTGRES_DB: health_mgmt
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ${DB_PASSWORD:-admin123}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - '5432:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U admin -d health_mgmt']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - health-mgmt

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis123}
    volumes:
      - redis_data:/data
    ports:
      - '6379:6379'
    healthcheck:
      test: ['CMD', 'redis-cli', '-a', '${REDIS_PASSWORD:-redis123}', '--no-auth-warning', 'ping']
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - health-mgmt

  # InfluxDB 时序数据库
  influxdb:
    image: influxdb:2.7-alpine
    container_name: influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD:-influx123}
      DOCKER_INFLUXDB_INIT_ORG: vakyi
      DOCKER_INFLUXDB_INIT_BUCKET: health_data
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_TOKEN:-my-super-secret-auth-token}
    volumes:
      - influxdb_data:/var/lib/influxdb2
    ports:
      - '8086:8086'
    networks:
      - health-mgmt

  # Qdrant 向量数据库
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    volumes:
      - qdrant_data:/qdrant/storage
    ports:
      - '6333:6333'
      - '6334:6334'
    healthcheck:
      test: ['CMD-SHELL', 'test -f /qdrant/.qdrant-initialized || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - health-mgmt

  # MongoDB (消息存储)
  mongodb:
    image: mongo:6
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-mongo123}
      MONGO_INITDB_DATABASE: health_messages
    volumes:
      - mongo_data:/data/db
    ports:
      - '27017:27017'
    networks:
      - health-mgmt

  # EMQX MQTT Broker
  emqx:
    image: emqx/emqx:latest
    container_name: emqx
    environment:
      EMQX_NAME: emqx
      EMQX_HOST: ${EMQX_HOST:-emqx}
      EMQX_DASHBOARD__DEFAULT_USERNAME: admin
      EMQX_DASHBOARD__DEFAULT_PASSWORD: ${EMQX_PASSWORD:-emqx123}
      # PostgreSQL 连接信息 (用于设备认证和 ACL)
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: health_mgmt
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ${DB_PASSWORD:-admin123}
    volumes:
      - emqx_data:/opt/emqx/data
      - emqx_log:/opt/emqx/log
      # 挂载配置文件
      - ./emqx/emqx.conf:/opt/emqx/etc/emqx.conf:ro
      - ./emqx/auth-pgsql.conf:/opt/emqx/etc/auth-pgsql.conf:ro
      - ./emqx/acl.conf:/opt/emqx/etc/acl.conf:ro
    ports:
      - '1883:1883' # MQTT
      - '8883:8883' # MQTT/SSL
      - '8083:8083' # WebSocket
      - '18083:18083' # Dashboard
    depends_on:
      - postgres
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:18083/api/v5/status || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - health-mgmt

  # MinIO 对象存储
  minio:
    image: minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_USER:-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD:-minio123}
    volumes:
      - minio_data:/data
    ports:
      - '9000:9000' # API
      - '9001:9001' # Console
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - health-mgmt

  # ================================
  # 应用服务
  # ================================

  # NestJS 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend
    environment:
      NODE_ENV: production
      PORT: 5000
      # 数据库配置
      DATABASE_URL: postgresql://admin:${DB_PASSWORD:-admin123}@postgres:5432/health_mgmt
      # Redis 配置
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123}
      # InfluxDB 配置
      INFLUX_URL: http://influxdb:8086
      INFLUX_TOKEN: ${INFLUX_TOKEN:-my-super-secret-auth-token}
      INFLUX_ORG: vakyi
      INFLUX_BUCKET: health_data
      # MongoDB 配置
      MONGO_URI: mongodb://admin:${MONGO_PASSWORD:-mongo123}@mongodb:27017/health_messages?authSource=admin
      # MQTT 配置
      MQTT_BROKER_URL: mqtt://emqx:1883
      MQTT_USERNAME: ${MQTT_USERNAME:-admin}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-emqx123}
      # MinIO 配置
      MINIO_ENDPOINT: minio
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_USER:-admin}
      MINIO_SECRET_KEY: ${MINIO_PASSWORD:-minio123}
      # AI 服务配置
      AI_SERVICE_URL: http://ai-service:8001
      # JWT 配置
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-your-super-secret-refresh-jwt-key-change-in-production}
      JWT_EXPIRES_IN: 24h
    volumes:
      - ./backend/logs:/app/logs
    ports:
      - '5000:5000'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      influxdb:
        condition: service_started
      mongodb:
        condition: service_started
      qdrant:
        condition: service_started
      emqx:
        condition: service_started
      minio:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:5000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    networks:
      - health-mgmt
    restart: unless-stopped

  # Python AI 服务
  ai-service:
    build:
      context: ./ai-service
      dockerfile: Dockerfile
    container_name: ai-service
    environment:
      # 基础配置
      ENVIRONMENT: production
      LOG_LEVEL: INFO
      # Qdrant 配置
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      # DeepSeek API 配置
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      DEEPSEEK_API_BASE: https://api.deepseek.com/v1
      # 后端服务配置
      BACKEND_URL: http://backend:5000
      # JWT 配置（用于验证后端请求）
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
    volumes:
      - ./ai-service/logs:/app/logs
    ports:
      - '8001:8001'
    depends_on:
      - qdrant
    healthcheck:
      test:
        [
          'CMD',
          'python',
          '-c',
          "import urllib.request; urllib.request.urlopen('http://localhost:8001/health').read()",
        ]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    networks:
      - health-mgmt
    restart: unless-stopped

  # React 医生/管理端
  frontend-web:
    build:
      context: ./frontend-web
      dockerfile: Dockerfile
    container_name: frontend-web
    ports:
      - '3000:80'
    depends_on:
      - backend
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost/health']
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    networks:
      - health-mgmt
    restart: unless-stopped

  # Uni-app 患者端（H5）
  frontend-patient:
    build:
      context: ./frontend-patient
      dockerfile: Dockerfile
    container_name: frontend-patient
    ports:
      - '3001:80'
    depends_on:
      - backend
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost/health']
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    networks:
      - health-mgmt
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  influxdb_data:
  qdrant_data:
  mongo_data:
  emqx_data:
  emqx_log:
  minio_data:

networks:
  health-mgmt:
    driver: bridge
