version: '3.8'

# ================================
# 开发环境 Docker Compose 配置
# ================================

services:
  # ================================
  # 基础设施服务（7个）
  # ================================

  # PostgreSQL 主数据库
  postgres:
    image: postgres:15-alpine
    container_name: health-postgres
    environment:
      POSTGRES_DB: health_mgmt
      POSTGRES_USER: ${DB_USER:-admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-admin123}
    ports:
      - '5432:5432'
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - health_mgmt_net
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DB_USER:-admin} -d health_mgmt']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: health-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis123} --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - '6379:6379'
    volumes:
      - redis_data_dev:/data
    networks:
      - health_mgmt_net
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'redis-cli', '-a', '${REDIS_PASSWORD:-redis123}', '--no-auth-warning', 'ping']
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # InfluxDB 时序数据库
  influxdb:
    image: influxdb:2.7-alpine
    container_name: health-influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USER:-admin}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD:-influx123}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG:-vakyi}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET:-health_data}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_TOKEN:-my-super-secret-auth-token}
    ports:
      - '8086:8086'
    volumes:
      - influxdb_data_dev:/var/lib/influxdb2
      - influxdb_config_dev:/etc/influxdb2
    networks:
      - health_mgmt_net
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'influx', 'ping']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # Qdrant 向量数据库
  qdrant:
    image: qdrant/qdrant:v1.16.2
    container_name: health-qdrant
    ports:
      - '6333:6333'
      - '6334:6334'
    volumes:
      - qdrant_data_dev:/qdrant/storage
    networks:
      - health_mgmt_net
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:6333/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # MongoDB 消息存储
  mongodb:
    image: mongo:6
    container_name: health-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-mongo123}
      MONGO_INITDB_DATABASE: health_messages
    ports:
      - '27017:27017'
    volumes:
      - mongodb_data_dev:/data/db
      - mongodb_config_dev:/data/configdb
    networks:
      - health_mgmt_net
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # EMQX MQTT Broker
  emqx:
    image: emqx/emqx:5.4.1
    container_name: health-emqx
    environment:
      EMQX_NAME: emqx
      EMQX_HOST: ${EMQX_HOST:-emqx}
      EMQX_DASHBOARD__DEFAULT_USERNAME: ${EMQX_USER:-admin}
      EMQX_DASHBOARD__DEFAULT_PASSWORD: ${EMQX_PASSWORD:-emqx123}
      EMQX_LOADED_PLUGINS: 'emqx_dashboard,emqx_management,emqx_auth_mnesia'
      # PostgreSQL 连接信息（用于设备认证和 ACL）
      POSTGRES_HOST: health-postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: health_mgmt
      POSTGRES_USER: ${DB_USER:-admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-admin123}
    ports:
      - '1883:1883' # MQTT
      - '8883:8883' # MQTT/SSL
      - '8083:8083' # WebSocket
      - '18083:18083' # Dashboard
    volumes:
      - emqx_data_dev:/opt/emqx/data
      - emqx_log_dev:/opt/emqx/log
      # 配置文件挂载（如果存在）
      - ./emqx/emqx.conf:/opt/emqx/etc/emqx.conf:ro
      - ./emqx/auth-pgsql.conf:/opt/emqx/etc/auth-pgsql.conf:ro
      - ./emqx/acl.conf:/opt/emqx/etc/acl.conf:ro
    networks:
      - health_mgmt_net
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'emqx', 'ping']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # MinIO 对象存储
  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: health-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_USER:-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD:-minio123}
    ports:
      - '9000:9000' # API
      - '9001:9001' # Console
    volumes:
      - minio_data_dev:/data
    networks:
      - health_mgmt_net
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

# ================================
# 数据卷（持久化存储）
# ================================
volumes:
  postgres_data_dev:
    driver: local
  redis_data_dev:
    driver: local
  influxdb_data_dev:
    driver: local
  influxdb_config_dev:
    driver: local
  qdrant_data_dev:
    driver: local
  mongodb_data_dev:
    driver: local
  mongodb_config_dev:
    driver: local
  emqx_data_dev:
    driver: local
  emqx_log_dev:
    driver: local
  minio_data_dev:
    driver: local

# ================================
# 网络
# ================================
networks:
  health_mgmt_net:
    driver: bridge
