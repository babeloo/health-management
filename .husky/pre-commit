#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# --- 颜色定义 ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

DIVIDER="──────────────────────────────────────────────────"

# 1. 核心逻辑：PM Protocol 检查
echo "${BLUE}${DIVIDER}${NC}"
echo "${BLUE}${BOLD}[PM Protocol] 正在验证任务进度...${NC}"

STAGED_FILES=$(git diff --cached --name-only)
CODE_CHANGES=$(echo "$STAGED_FILES" | grep -E "^src/|^app/|.*\.ts$|.*\.js$|.*\.py$|.*\.vue$")

if [ -n "$CODE_CHANGES" ] && ! echo "$STAGED_FILES" | grep -q "tasks.md"; then
    echo "${RED}${BOLD}❌ 验证失败: 发现代码变动但未更新 tasks.md${NC}"
    echo "${YELLOW}请更新任务清单后再尝试提交。${NC}"
    echo "${RED}${DIVIDER}${NC}"
    exit 1
fi

echo "${GREEN}✅ 进度验证通过${NC}"

# 2. 执行 lint-staged
echo "${BLUE}${BOLD}[Lint] 正在运行代码规范检查...${NC}"
npx lint-staged

# 检查 lint-staged 的退出状态
if [ $? -ne 0 ]; then
    echo "${RED}${BOLD}❌ 代码规范检查失败，请修复后再提交${NC}"
    echo "${RED}${DIVIDER}${NC}"
    exit 1
fi

echo "${BLUE}${DIVIDER}${NC}"
